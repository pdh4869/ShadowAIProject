# PII Agent - 개인정보 탐지 시스템

ChatGPT 및 Gemini에서 파일 업로드 시 개인정보를 자동으로 탐지하는 Chrome 확장 프로그램 + Python 서버 시스템입니다.

## 주요 기능

### 📄 지원 파일 형식
- **문서**: PDF, DOC→DOCX, DOCX, HWP, HWPX, TXT
- **오피스**: XLS→XLSX, XLSX, PPTX
- **이미지**: PNG, JPG, JPEG, BMP, WEBP, GIF, TIFF

**구버전 파일 자동 변환** (pywin32 + Microsoft Office 필요):
- `.doc` → `.docx` 자동 변환 후 처리
- `.xls` → `.xlsx` 자동 변환 후 처리
- `.ppt` 파일은 지원하지 않음 (PPTX로 변환 후 업로드)

### 🔍 탐지 항목

#### 식별자 (개인을 직접 특정 가능)
- **이름** (PS, PER): NER 모델 + 신뢰도 필터링
  - 2글자: 신뢰도 90% 이상
  - 3글자: 제한 없음
  - 4글자 이상: 신뢰도 80% 이상
- **주민번호**: 생년월일 + 체크섬 검증
- **전화번호**: 010-1234-5678, 01012345678, 지역번호 포함
- **이메일**: 표준 이메일 형식
- **카드번호**: Luhn 알고리즘 검증
- **계좌번호**: 14자리 패턴
- **운전면허**: 지역코드 검증
- **여권번호**: 알파벳+숫자 조합
- **외국인등록번호**: 5-8로 시작하는 13자리

#### 민감정보
- **얼굴사진**: MTCNN 모델 (신뢰도 98% 이상)

#### 준식별자 (조합시 특정 가능)
- **조직명** (ORG): 2글자 이상, 숫자만 제외
- **주소** (LC): 자동 병합 처리
- **직책**: 교수, 팀장, 부장, 선생님, 교사 등 40여가지

#### NER 모델
- **모델**: `soddokayo/klue-roberta-base-ner`
- **필터링**:
  - 한글 없으면 제외
  - 숫자만 있으면 제외
  - 조직명 키워드 있으면 ORG로 재분류
  - 신뢰도 기반 필터링 (글자 수별 차등 적용)
  - 접두사 제거 ("저는", "나는", "제가" 등)

#### 이미지 분석
- **얼굴 탐지**: MTCNN 모델 (신뢰도 98% 이상)
  - 얼굴 크기, 비율, keypoints 검증으로 오탐지 방지
  - 중복 이미지 자동 제거 (PDF)
- **OCR**: EasyOCR (한글/영어)
  - DOCX, PDF, HWP, HWPX, PPTX 내부 이미지 지원
  - 단일 이미지 파일 지원
  - 이미지 전처리 (대비 증가)

### 🚨 조합 위험도 분석

#### 치명적 (CRITICAL)
- 민감정보 + 식별자 조합 → 개인 완전 특정 가능!

#### 고위험 (HIGH)
- **식별자 3개 이상** → 개인 특정 가능
- 식별자 + 준식별자 2개 이상 → 개인 특정 가능

#### 중위험 (MEDIUM)
- **식별자 2개** → 개인 특정 가능성 있음
- 식별자 + 준식별자 1개 → 개인 특정 가능성 있음
- 준식별자 2개 이상 (조직명 제외) → 개인 특정 가능성 있음

**조합 위험도가 없으면 준식별자(조직명, 주소, 직책)는 결과에서 제외됩니다.**

### 🌐 네트워크 정보 수집
- IP 주소 (로컬 네트워크)
- 컴퓨터 호스트명
- 브라우저 User-Agent
- 출처 URL

## 시스템 구조

```
Py_server/
├── extension/          # Chrome 확장 프로그램
│   ├── manifest.json
│   ├── background.js   # Service Worker
│   └── content.js      # 파일 감지 및 전송
├── native_host/        # Native Messaging Host
│   ├── host.py         # 네트워크 정보 수집
│   └── com.example.pii_host.json
├── server/             # Python 서버
│   ├── LocalServer.py  # FastAPI 서버
│   └── Logic.py        # 개인정보 탐지 로직
├── requirements.txt    # Python 패키지 목록
└── install.bat         # 자동 설치 스크립트
```

## 설치 방법

### 1. 필수 요구사항
- Python 3.8 이상
- Google Chrome 브라우저
- Windows 10/11

### 2. 자동 설치 (권장)

1. `install.bat` 파일을 **관리자 권한으로 실행**
2. Python 패키지 자동 설치
3. Native Messaging Host 자동 등록

### 3. Chrome 확장 프로그램 설치

1. Chrome에서 `chrome://extensions/` 접속
2. 우측 상단 "개발자 모드" 활성화
3. "압축해제된 확장 프로그램을 로드합니다" 클릭
4. `Py_server/extension` 폴더 선택

### 4. 환경 변수 설정 (선택)

HuggingFace 토큰이 필요한 경우:

```bash
set HF_TOKEN=your_huggingface_token_here
```

또는 시스템 환경 변수에 `HF_TOKEN` 추가

## 실행 방법

### 1. 서버 실행

```bash
cd Py_server/server
python LocalServer.py
```

서버가 `http://127.0.0.1:9000`에서 실행됩니다.

### 2. 대시보드 접속

브라우저에서 `http://127.0.0.1:9000/dashboard` 접속하여 실시간 탐지 결과 확인

### 3. ChatGPT/Gemini에서 파일 업로드

- ChatGPT: `https://chatgpt.com`
- Gemini: `https://gemini.google.com`

파일 업로드 시 자동으로 개인정보 탐지 및 대시보드에 표시

## 주요 라이브러리

```
fastapi              # 웹 서버
uvicorn              # ASGI 서버
transformers         # NER 모델
torch                # 딥러닝 프레임워크
easyocr              # OCR
pymupdf              # PDF 파싱
pillow               # 이미지 처리
mtcnn                # 얼굴 탐지
python-docx          # DOCX 파싱
olefile              # HWP 파싱
openpyxl             # XLSX 파싱
python-pptx          # PPTX 파싱
pywin32              # DOC/XLS 변환 (Windows 전용)
```

## 파일별 처리 방식

| 파일 형식 | 텍스트 추출 | 이미지 OCR | 얼굴 탐지 | 특이사항 |
|----------|-----------|----------|---------|----------|
| PDF      | ✅        | ✅       | ✅      | 병렬 처리 (8 workers) ⚡ |
| DOC      | ✅        | ✅       | ✅      | Word로 DOCX 변환 후 처리 |
| DOCX     | ✅        | ✅       | ✅      | 테이블 지원, 병렬 OCR |
| HWP      | ✅        | ✅       | ✅      | 띄어쓰기 자동 병합 🔥 |
| HWPX     | ✅        | ✅       | ✅      | 최적화 (30-40% 향상) |
| XLS      | ✅        | ❌       | ❌      | Excel로 XLSX 변환 후 처리 |
| XLSX     | ✅        | ❌       | ❌      | 셀 단위 |
| PPTX     | ✅        | ✅       | ✅      | 슬라이드별, 병렬 OCR |
| TXT      | ✅        | ❌       | ❌      | UTF-8/CP949 |
| 이미지    | ❌        | ✅       | ✅      | 7가지 형식, 리사이즈 |

## 문제 해결

### HWP 파일에서 이름이 탐지 안 되는 경우

- HWP는 텍스트를 "이 무 송" 형태로 저장
- **자동 해결**: 한글 띄어쓰기 정규화 ("이 무 송" → "이무송")
- **정규식 이름 추출**: "성명이무송" 패턴 자동 인식
- **주소 자동 병합**: "##서울특별시", "##강남구" → "서울특별시 강남구"
- 서버 재시작 불필요 ✅

### "양진중학교 체육선생님"만 있으면 탐지 안 되나요?

- **조직명 + 직책만으로는 개인 특정 불가**
- 조합 위험도 없음 → 조직명, 직책 모두 결과에서 제외
- "홍길동 양진중학교 체육선생님" → 중위험 (이름+조직명+직책) → 모두 표시

### HWPX 파일이 "지원하지 않는 파일 형식"으로 나오는 경우

1. Chrome 확장 프로그램 새로고침 (`chrome://extensions/`)
2. 브라우저 캐시 삭제 (Ctrl + Shift + Delete)
3. ChatGPT/Claude 페이지 새로고침

### Native Host 프로세스가 쌓이는 경우

- `host.py`에서 stdin 종료 시 프로세스 종료 로직 구현됨
- Chrome 종료 시 자동으로 정리됨

### Service Worker 비활성화 문제

- 자동 재연결 로직 구현
- ping 메시지로 Service Worker 깨우기
- 포트 연결 실패 시 100ms 대기 후 재시도

### 파일 취소 시 전송되는 문제

- 드롭 후 취소 버튼 클릭 시 대기 파일 자동 삭제
- 취소 버튼 감지: aria-label, className 기반
- 500ms 지연으로 취소 여부 확인

## 개발 정보

### 개인정보 분류 기준

#### 식별자 (Identifier)
- 그 자체로 특정 개인을 직접 식별할 수 있는 정보
- 예: 이름, 주민번호, 전화번호, 이메일, 카드번호 등

#### 민감정보 (Sensitive)
- 개인의 사생활을 침해할 수 있는 정보
- 예: 얼굴사진

#### 준식별자 (Quasi-identifier)
- 단독으로는 특정 불가하지만 조합하면 특정 가능
- 예: 조직명, 주소, 직책

### 생년월일 범위

- 1900~2006년생만 탐지
- 2007년 이후는 교육/근무 기간으로 간주하여 제외

### 주민등록번호 검증

- 생년월일 유효성 검사
- 체크섬 검증 (2020년 이후 출생자 제외)
- 성별 코드 검증 (1~8)
- 띄어쓰기/하이픈 우회 방지 (정규화 텍스트 검사)

### 운전면허번호 검증

- 지역코드 검증 (11~26, 24 제외)
- 12자리 패턴 (XX-XX-XXXXXX-XX)
- 유효하지 않은 면허번호는 탐지 제외

### 카드번호 검증

- Luhn 알고리즘 적용
- 16자리 숫자 (띄어쓰기/하이픈 포함 가능)
- 유효하지 않은 카드번호는 "invalid" 표시

### 직책 패턴

- **일반 직책**: 교수, 팀장, 부장, 과장, 대리, 사원, 이사, 회장, 사장 등
- **교육 관련**: 선생님, 교사, 강사, 교장, 교감, 학생부장
- **과목별**: 체육교사, 국어교사, 수학교사, 영어교사 등
- **복합 직책**: 체육선생님, 국어선생님 등 40여가지

### 파일 크기 제한

- Soft Limit: 20MB (경고 로그)
- Hard Limit: 100MB (거부)
- 최대 파일 개수: 10개
- Base64 인코딩 크기 기준

## 라이선스

이 프로젝트는 개인정보 보호를 위한 교육 및 연구 목적으로 제작되었습니다.

## 🚀 성능 최적화

### 병렬 처리 (ThreadPoolExecutor)
- **PDF 얼굴 탐지**: 최대 8 workers, CPU 코어 수 동적 조정
- **DOCX/HWP/PPTX OCR**: 최대 4 workers
- **이미지 1개**: 순차 처리 (오버헤드 방지)
- **효과**: 처리 속도 2-4배 향상 ⚡

### 이미지 처리 최적화
- **얼굴 탐지용 리사이즈**: 400px (속도 2-4배 향상)
- **PDF 중복 이미지 제거**: xref 기반
- **작은 이미지 스킵**: 5KB 이하 (로고/아이콘)
- **효과**: 메모리 사용량 50% 감소 💾

### 정규식 패턴 캐싱
- **모듈 레벨 컴파일**: `COMPILED_PATTERNS`, `COMPILED_NORMALIZED_PATTERNS`
- **효과**: 정규식 탐지 속도 10-20% 향상 🎯

### HWPX 파싱 최적화
- **불필요한 XML 제외**: settings, styles, header, footer
- **Contents/ 우선 처리**: 텍스트 콘텐츠만
- **효과**: HWPX 처리 속도 30-40% 향상 📄

### 디버그 로그 최적화
- **환경 변수 제어**: `PII_DEBUG=false` (기본값)
- **중요 로그만 유지**: INFO, ERROR
- **효과**: 로그 오버헤드 제거, 가독성 향상 📝

### 메모리 관리
- **메모리 누수 방지**: deque, maxlen=1000
- **텍스트 정규화 캐싱**: 반복 처리 방지
- **효과**: 장시간 실행 안정성 향상 🛡️

**전체 성능 개선: 처리 속도 2-3배 향상, 메모리 50% 절감**

## 보안 기능

- CORS 화이트리스트 (Extension ID 기반)
- HMAC 인증 (선택적, 환경변수 `PII_REQUIRE_AUTH=true`)
- 타임스탬프 검증 (5분 이내)
- 암호화된 문서 감지 및 거부

## 주의사항

⚠️ 이 시스템은 개인정보 탐지를 위한 보조 도구이며, 100% 정확도를 보장하지 않습니다.
⚠️ 중요한 개인정보는 반드시 수동으로 확인하시기 바랍니다.
⚠️ NER 모델은 문맥에 따라 오탐지/미탐지가 발생할 수 있습니다.
⚠️ 얼굴 탐지는 신뢰도 98% 이상만 표시하지만, 완벽하지 않습니다.
