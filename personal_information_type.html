<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>개인정보 유형별 현황</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<link rel="stylesheet" href="assets/css/common.css">
<link rel="stylesheet" href="assets/page-css/personal_information_type.page.css">
</head>
<body>
  <div class="brandbar" onclick="location.href='main.html'" style="cursor:pointer"><div class="dot"></div> Privacy Monitor</div>
  <div class="pm-container">
    <div class="page-title">개인정보 유형</div>
    <div class="pm-navwrap">
      <nav class="pm-nav" aria-label="주요 메뉴">
        <a href="#" onclick="location.href='detection_details.html'">탐지 현황</a>
        <a href="#" onclick="location.href='detection_type.html'">탐지 유형</a>
        <a href="#" onclick="location.href='personal_information_type.html'">개인정보 유형</a>
        <a href="#" onclick="location.href='account_management.html'">계정 관리</a>
      </nav>
    </div>

    <div class="max-w-6xl mx-auto p-4">
    <div style="display:flex;gap:16px;margin-bottom:16px;align-items:stretch;">
      <!-- 필터 카드 -->
      <section class="card" style="flex:1;" aria-label="필터">
        <div class="quick" aria-label="빠른 기간 선택">
          <button class="pill" data-range="today">오늘</button>
          <button class="pill" data-range="lastweek">지난 주</button>
          <button class="pill" data-range="lastmonth">지난 달</button>
          <span class="muted" id="quickDesc" style="font-size:12px;margin-left:16px;vertical-align:middle;text-align:center;display:block;"></span>
        </div>

        <div class="filters" style="display:block !important;">
          <!-- 2줄: 시작/종료 일자 -->
          <div style="display:flex !important;gap:12px;margin-bottom:12px;">
            <div class="field" style="flex:1 !important;grid-column:unset !important;">
              <label for="from">시작 일자</label>
              <input type="date" id="from" />
            </div>
            <div class="field" style="flex:1 !important;grid-column:unset !important;">
              <label for="to">종료 일자</label>
              <input type="date" id="to" />
            </div>
          </div>
          
          <!-- 3줄: 개인정보 유형/소스 유형 -->
          <div style="display:flex !important;gap:12px;margin-bottom:12px;">
            <div class="field" style="flex:1 !important;grid-column:unset !important;">
              <label for="type">개인정보 유형</label>
              <select id="type">
                <option value="">전체</option>
                <option>전화번호</option><option>이메일</option>
                <option>주민등록번호</option><option>카드번호</option>
                <option>IP 주소</option><option>생년월일</option>
              </select>
            </div>
            <div class="field" style="flex:1 !important;grid-column:unset !important;">
              <label for="source">소스 유형</label>
              <select id="source">
                <option value="">전체</option>
                <option>텍스트</option><option>PDF</option><option>DOCX</option><option>XLSX</option><option>TXT</option>
              </select>
            </div>
          </div>
          
          <!-- 4줄: 상태/사용자 -->
          <div style="display:flex !important;gap:12px;margin-bottom:12px;">
            <div class="field" style="flex:1 !important;grid-column:unset !important;">
              <label for="status">상태</label>
              <select id="status">
                <option value="">전체</option>
                <option>성공</option><option>실패</option>
              </select>
            </div>
            <div class="field" style="flex:1 !important;grid-column:unset !important;">
              <label for="emp">사용자</label>
              <input id="emp" placeholder="예: A1023, S0001" />
            </div>
          </div>
          
          <!-- 5줄: 검색 -->
          <div class="field search" style="margin-bottom:12px;grid-column:unset !important;">
            <label for="q">검색(파일명/유형/사유/소스/사번)</label>
            <input id="q" placeholder="예: report.pdf, 전화번호, 암호화 파일, A1023..." />
          </div>
        </div>

        <div class="toolbar">
          <div class="muted" id="summary">총 0건</div>
          <div class="actions">
            <button class="btn ghost" id="resetBtn">초기화</button>
            <button class="btn primary" id="applyBtn">적용</button>
          </div>
        </div>
      </section>

      <!-- 차트 -->
      <section class="card chart-card" style="flex:1;display:flex;flex-direction:column;margin-top:0 !important;" aria-label="유형별 그래프">
        <h2 style="font-size:16px;margin:6px 0 16px 0;text-align:center;">개인정보 유형별 분포 (원형)</h2>
        <div class="chart-wrap" style="flex:1;display:flex;align-items:center;justify-content:center;padding:20px;">
          <div style="position:relative;width:100%;height:100%;max-width:400px;max-height:400px;display:flex;align-items:center;justify-content:center;">
            <canvas id="pieChart" aria-label="유형별 분포 파이차트"></canvas>
          </div>
        </div>
      </section>
    </div>

    <!-- 목록 -->
    <section class="card" style="margin-top:16px" aria-label="목록">
      <div class="table-wrap">
        <table aria-describedby="summary">
          <thead>
            <tr>
              <th style="width:100px;text-align:center;">상태</th>
              <th style="width:120px;text-align:center;">일자</th>
              <th style="width:110px;text-align:center;">사번</th><!-- 추가 열 -->
              <th style="width:220px;text-align:center;">개인정보 유형</th>
              <th style="width:140px;text-align:center;">소스 유형</th>
              <th style="text-align:center;">파일명</th>
              <th style="text-align:center;">실패 사유</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="empty" id="empty" hidden>조건에 맞는 결과가 없습니다.</div>
    </section>
    </div>
  </div>

  <!-- 세부 내용 팝업 모달 -->
  <div id="detailModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1000;backdrop-filter:blur(2px);">
    <div class="modal-content card" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;width:min(90vw,900px);max-height:95vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.15);">
      <div class="modal-header" style="background:#f8fafc;padding:16px 20px;border-bottom:1px solid #e2e8f0;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:18px;font-weight:600;color:#1e293b;">탐지 결과 상세</h3>
          <button id="closeModal" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#64748b;font-size:16px;transition:all 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">&times;</button>
        </div>
      </div>
      <div class="modal-body" style="padding:20px;max-height:calc(95vh - 100px);overflow-y:auto;">
        <div class="detail-sections">
          <!-- 기본 정보 -->
          <div class="detail-section" style="margin-bottom:18px;">
            <h4 style="margin:0 0 10px 0;font-size:14px;font-weight:600;color:#374151;border-bottom:1px solid #e2e8f0;padding-bottom:4px;">기본 정보</h4>
            <div class="detail-grid" style="display:flex;gap:12px;flex-wrap:wrap;">
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:0 0 auto;min-width:120px;">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">상태</div>
                <div id="detail-status" style="font-size:13px;font-weight:700;white-space:nowrap;">-</div>
              </div>
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:0 0 auto;min-width:120px;">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">사번</div>
                <div id="detail-emp" style="font-size:13px;font-weight:600;white-space:nowrap;">-</div>
              </div>
            </div>
          </div>
          
          <!-- 시스템 정보 -->
          <div class="detail-section" style="margin-bottom:18px;">
            <h4 style="margin:0 0 10px 0;font-size:14px;font-weight:600;color:#374151;border-bottom:1px solid #e2e8f0;padding-bottom:4px;">시스템 정보</h4>
            <div class="detail-grid" style="display:flex;gap:12px;flex-wrap:wrap;">
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:0 0 auto;min-width:140px;">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">IP 주소</div>
                <div id="detail-ip" style="font-size:13px;font-weight:600;white-space:nowrap;">-</div>
              </div>
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:0 0 auto;min-width:140px;">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">운영체제</div>
                <div id="detail-os" style="font-size:13px;font-weight:600;white-space:nowrap;">-</div>
              </div>
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:0 0 auto;min-width:fit-content;">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">컴퓨터 이름</div>
                <div id="detail-computer" style="font-size:13px;font-weight:600;white-space:nowrap;">-</div>
              </div>
            </div>
          </div>
          
          <!-- 웹 정보 -->
          <div class="detail-section" style="margin-bottom:18px;">
            <h4 style="margin:0 0 10px 0;font-size:14px;font-weight:600;color:#374151;border-bottom:1px solid #e2e8f0;padding-bottom:4px;">웹 정보</h4>
            <div class="detail-grid" style="display:flex;gap:12px;flex-wrap:wrap;">
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:0 0 auto;min-width:100px;">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">브라우저</div>
                <div id="detail-browser" style="font-size:13px;font-weight:600;white-space:nowrap;">-</div>
              </div>
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:0 0 auto;min-width:80px;">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">LLM</div>
                <div id="detail-llm" style="font-size:13px;font-weight:600;white-space:nowrap;">-</div>
              </div>
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:0 0 auto;min-width:fit-content;max-width:400px;">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">URL</div>
                <div id="detail-url" style="font-size:12px;font-weight:700;word-break:break-all;overflow-wrap:break-word;">-</div>
              </div>
            </div>
          </div>
          
          <!-- 탐지 정보 -->
          <div class="detail-section">
            <h4 style="margin:0 0 10px 0;font-size:14px;font-weight:600;color:#374151;border-bottom:1px solid #e2e8f0;padding-bottom:4px;">탐지 정보</h4>
            <div class="detail-grid" style="display:flex;gap:12px;flex-wrap:wrap;">
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:0 0 auto;min-width:120px;">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">탐지 유형</div>
                <div id="detail-source" style="font-size:13px;font-weight:600;white-space:nowrap;">-</div>
              </div>
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:0 0 auto;min-width:fit-content;">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">개인정보 유형</div>
                <div id="detail-types" style="font-size:13px;font-weight:600;">-</div>
              </div>
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:0 0 auto;min-width:fit-content;" id="validation-section">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">검증 결과</div>
                <div id="detail-validation" style="font-size:13px;font-weight:600;">-</div>
              </div>
              <div class="detail-item" style="background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e2e8f0;flex:1 1 100%;" id="reason-section">
                <div style="font-size:11px;color:#64748b;font-weight:500;margin-bottom:3px;">실패 사유</div>
                <div id="detail-reason" style="font-size:13px;font-weight:600;">-</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ==== 샘플 데이터 (emp 포함) ==== */
const DATA = [
  {emp:'S0001', status:'실패', date:'2025-10-15', types:[], source:'DOCX', filename:'analysis.xlsx', reason:'빈 파일'},
  {emp:'A1023', status:'성공', date:'2025-10-15', types:['IP 주소'], source:'텍스트', filename:'-', reason:''},
  {emp:'A1138', status:'성공', date:'2025-10-15', types:['생년월일'], source:'텍스트', filename:'-', reason:''},
  {emp:'B2047', status:'성공', date:'2025-10-14', types:['IP 주소'], source:'텍스트', filename:'-', reason:''},
  {emp:'B2099', status:'성공', date:'2025-10-13', types:['이메일','카드번호'], source:'PDF', filename:'cards.txt', reason:''},
  {emp:'A1200', status:'실패', date:'2025-10-12', types:[], source:'TXT', filename:'contacts.xlsx', reason:'암호화 파일'},
  {emp:'B3001', status:'성공', date:'2025-10-11', types:['카드번호','이메일'], source:'XLSX', filename:'report.pdf', reason:''},
  {emp:'S0001', status:'실패', date:'2025-10-10', types:[], source:'XLSX', filename:'invoice.pdf', reason:'암호화 파일'},
  {emp:'A1023', status:'성공', date:'2025-10-09', types:['IP 주소'], source:'텍스트', filename:'-', reason:''},
  {emp:'A1138', status:'성공', date:'2025-10-08', types:['전화번호'], source:'텍스트', filename:'-', reason:''},
  {emp:'B2047', status:'성공', date:'2025-10-07', types:['주민등록번호'], source:'텍스트', filename:'-', reason:''},
  {emp:'B2099', status:'실패', date:'2025-10-06', types:[], source:'텍스트', filename:'-', reason:'지원 불가 형식'},
  {emp:'A1200', status:'실패', date:'2025-10-05', types:[], source:'XLSX', filename:'invoice.pdf', reason:'지원 불가 형식'},
  {emp:'B3001', status:'성공', date:'2025-10-04', types:['IP 주소'], source:'TXT', filename:'cards.txt', reason:''},
  {emp:'S0001', status:'실패', date:'2025-10-03', types:[], source:'DOCX', filename:'cards.txt', reason:'빈 파일'},
  {emp:'A1023', status:'성공', date:'2025-10-02', types:['생년월일'], source:'PDF', filename:'draft.docx', reason:''},
  {emp:'A1138', status:'성공', date:'2025-10-01', types:['주민등록번호','카드번호'], source:'XLSX', filename:'data.xlsx', reason:''},
  {emp:'B2047', status:'성공', date:'2025-09-30', types:['주민등록번호','생년월일'], source:'DOCX', filename:'summary.pdf', reason:''},
  {emp:'B2099', status:'실패', date:'2025-09-29', types:[], source:'XLSX', filename:'resume.docx', reason:'손상 파일'},
  {emp:'A1200', status:'성공', date:'2025-09-28', types:['생년월일'], source:'텍스트', filename:'-', reason:''},
  {emp:'B3001', status:'성공', date:'2025-09-27', types:['카드번호'], source:'텍스트', filename:'-', reason:''},
  {emp:'S0001', status:'성공', date:'2025-09-26', types:['이메일','주민등록번호'], source:'XLSX', filename:'log.xlsx', reason:''},
  {emp:'A1023', status:'실패', date:'2025-09-25', types:[], source:'DOCX', filename:'draft.docx', reason:'빈 파일'},
  {emp:'A1138', status:'실패', date:'2025-09-24', types:[], source:'XLSX', filename:'summary.pdf', reason:'지원 불가 형식'},
  {emp:'B2047', status:'성공', date:'2025-09-23', types:['IP 주소','전화번호'], source:'TXT', filename:'user_notes.txt', reason:''},
  {emp:'B2099', status:'성공', date:'2025-09-22', types:['카드번호'], source:'TXT', filename:'summary.pdf', reason:''},
  {emp:'A1200', status:'성공', date:'2025-09-21', types:['카드번호'], source:'텍스트', filename:'-', reason:''},
  {emp:'B3001', status:'성공', date:'2025-09-20', types:['주민등록번호','카드번호'], source:'PDF', filename:'draft.docx', reason:''},
  {emp:'S0001', status:'성공', date:'2025-09-19', types:['전화번호','이메일'], source:'PDF', filename:'draft.docx', reason:''},
  {emp:'A1023', status:'성공', date:'2025-09-18', types:['카드번호'], source:'TXT', filename:'apply.docx', reason:''},
  {emp:'A1138', status:'실패', date:'2025-09-17', types:[], source:'TXT', filename:'apply.docx', reason:'지원 불가 형식'},
  {emp:'B2047', status:'성공', date:'2025-09-16', types:['전화번호'], source:'XLSX', filename:'contacts.xlsx', reason:''},
  {emp:'B2099', status:'실패', date:'2025-09-15', types:[], source:'DOCX', filename:'data.xlsx', reason:'지원 불가 형식'},
  {emp:'A1200', status:'성공', date:'2025-09-14', types:['주민등록번호'], source:'PDF', filename:'cards.txt', reason:''},
  {emp:'B3001', status:'성공', date:'2025-09-13', types:['IP 주소'], source:'텍스트', filename:'-', reason:''},
  {emp:'S0001', status:'성공', date:'2025-09-12', types:['IP 주소'], source:'XLSX', filename:'contacts.xlsx', reason:''},
  {emp:'A1023', status:'실패', date:'2025-09-11', types:[], source:'XLSX', filename:'draft.docx', reason:'지원 불가 형식'},
  {emp:'A1138', status:'성공', date:'2025-09-10', types:['이메일','카드번호'], source:'XLSX', filename:'log.xlsx', reason:''},
  {emp:'B2047', status:'실패', date:'2025-09-09', types:[], source:'텍스트', filename:'-', reason:'지원 불가 형식'},
  {emp:'B2099', status:'성공', date:'2025-09-08', types:['전화번호'], source:'TXT', filename:'summary.pdf', reason:''},
  {emp:'A1200', status:'성공', date:'2025-09-07', types:['전화번호'], source:'DOCX', filename:'invoice.pdf', reason:''},
  {emp:'B3001', status:'성공', date:'2025-09-06', types:['카드번호'], source:'텍스트', filename:'-', reason:''},
  {emp:'S0001', status:'성공', date:'2025-09-05', types:['전화번호'], source:'XLSX', filename:'analysis.xlsx', reason:''},
  {emp:'A1023', status:'성공', date:'2025-09-04', types:['생년월일','전화번호'], source:'XLSX', filename:'invoice.pdf', reason:''},
  {emp:'A1138', status:'성공', date:'2025-09-22', types:['이메일'], source:'TXT', filename:'q3_report.pdf', reason:''},
  {emp:'B2047', status:'실패', date:'2025-09-15', types:[], source:'텍스트', filename:'-', reason:'암호화 파일'},
  {emp:'B2099', status:'실패', date:'2025-09-23', types:[], source:'XLSX', filename:'draft.docx', reason:'지원 불가 형식'},
  {emp:'A1200', status:'성공', date:'2025-09-19', types:['IP 주소'], source:'텍스트', filename:'-', reason:''},
  {emp:'B3001', status:'실패', date:'2025-09-23', types:[], source:'TXT', filename:'data.xlsx', reason:'손상 파일'},
  {emp:'S0001', status:'성공', date:'2025-09-14', types:['전화번호'], source:'PDF', filename:'q3_report.pdf', reason:''},
  {emp:'A1023', status:'실패', date:'2025-09-21', types:[], source:'DOCX', filename:'analysis.xlsx', reason:'빈 파일'},
  {emp:'A1138', status:'성공', date:'2025-09-24', types:['전화번호','IP 주소'], source:'텍스트', filename:'-', reason:''},
  {emp:'B2047', status:'성공', date:'2025-09-24', types:['이메일'], source:'XLSX', filename:'user_notes.txt', reason:''},
  {emp:'B2099', status:'실패', date:'2025-09-24', types:[], source:'텍스트', filename:'-', reason:'빈 파일'},
  {emp:'A1200', status:'성공', date:'2025-09-24', types:['주민등록번호'], source:'TXT', filename:'notes.txt', reason:''},
  {emp:'B3001', status:'성공', date:'2025-09-10', types:['주민등록번호'], source:'PDF', filename:'draft.docx', reason:''},
  {emp:'S0001', status:'성공', date:'2025-09-18', types:['카드번호','주민등록번호'], source:'DOCX', filename:'summary.pdf', reason:''},
  {emp:'A1023', status:'성공', date:'2025-09-15', types:['IP 주소'], source:'TXT', filename:'apply.docx', reason:''}
];

const $ = (sel) => document.querySelector(sel);

// 날짜 유틸
function fmt(d){ return d.toISOString().slice(0,10); }
function startOfWeek(d){ const day=d.getDay(); const diff=(day===0?-6:1-day); const r=new Date(d); r.setDate(d.getDate()+diff); r.setHours(0,0,0,0); return r; }
function endOfWeek(d){ const s=startOfWeek(d); const r=new Date(s); r.setDate(s.getDate()+6); r.setHours(23,59,59,999); return r; }
function startOfLastWeek(d){ const s=startOfWeek(d); s.setDate(s.getDate()-7); return s; }
function endOfLastWeek(d){ const e=endOfWeek(d); e.setDate(e.getDate()-7); return e; }
function startOfLastMonth(d){ return new Date(d.getFullYear(), d.getMonth()-1, 1); }
function endOfLastMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 0); }

// 빠른 기간
function setQuickRange(kind){
  const now = new Date(); // 현재 날짜 사용
  let from, to, label='';
  if(kind==='today'){ 
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const todayStr = `${year}-${month}-${day}`;
    from = new Date(todayStr); to = new Date(todayStr); label = '오늘'; 
  }
  else if(kind==='lastweek'){ 
    from = new Date(now); from.setDate(now.getDate() - 7);
    to = new Date(now); to.setDate(now.getDate() - 1);
    label = '지난 주'; 
  }
  else if(kind==='lastmonth'){ 
    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
    from = new Date(lastMonth.getFullYear() + '-' + String(lastMonth.getMonth() + 1).padStart(2, '0') + '-01');
    to = new Date(lastMonthEnd.getFullYear() + '-' + String(lastMonthEnd.getMonth() + 1).padStart(2, '0') + '-' + String(lastMonthEnd.getDate()).padStart(2, '0'));
    label = '지난 달'; 
  }
  else{ return; }
  $('#from').value = fmt(from);
  $('#to').value = fmt(to);
  $('#quickDesc').textContent = `· ${label}: ${fmt(from)} ~ ${fmt(to)}`;
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  const btn = document.querySelector(`.pill[data-range="${kind}"]`);
  if(btn) btn.classList.add('active');
  applyFilters();
}

// 필터 적용
function applyFilters(){
  const from = $('#from').value;
  const to = $('#to').value;
  const type = $('#type').value;
  const source = $('#source').value;
  const status = $('#status').value;
  const emp = ($('#emp')?.value || '').trim().toLowerCase();
  const q = $('#q').value.trim().toLowerCase();

  let filtered = DATA.filter(row => {
    if (from && row.date < from) return false;
    if (to && row.date > to) return false;
    if (type && !(row.types || []).includes(type)) return false;
    if (source && row.source !== source) return false;
    if (status && row.status !== status) return false;
    if (emp && !(row.emp||'').toLowerCase().includes(emp)) return false;
    if (q){
      const hay = [(row.types||[]).join(','),row.source,row.filename,row.reason,row.status,row.date,row.emp].join(' ').toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  renderRows(filtered);
  renderChart(filtered);
}

/* 개인정보 유형 그룹 분류 */
const PII_GROUPS = {
  '연락처 정보': ['전화번호', '이메일'],
  '신원 정보': ['이름', '생년월일'],
  '위치 정보': ['장소', 'IP 주소', '조직명'],
  '신분증/증명서': ['주민등록번호', '외국인번호', '여권', '운전면허'],
  '금융 정보': ['카드번호', '계좌번호']
};

const GROUP_COLORS = {
  '연락처 정보': 'rgba(59,130,246,0.15)',
  '신원 정보': 'rgba(6,182,212,0.15)',
  '위치 정보': 'rgba(245,158,11,0.15)',
  '신분증/증명서': 'rgba(236,72,153,0.15)',
  '금융 정보': 'rgba(139,92,246,0.15)'
};

const GROUP_TEXT_COLORS = {
  '연락처 정보': '#1e40af',
  '신원 정보': '#0891b2',
  '위치 정보': '#d97706',
  '신분증/증명서': '#be185d',
  '금융 정보': '#7c3aed'
};

function getTypeGroup(type) {
  for (const [group, types] of Object.entries(PII_GROUPS)) {
    if (types.includes(type)) return group;
  }
  return '기타';
}

function getTypeColor(type) {
  const group = getTypeGroup(type);
  return GROUP_COLORS[group] || 'rgba(107,114,128,0.15)';
}

function getTypeTextColor(type) {
  const group = getTypeGroup(type);
  return GROUP_TEXT_COLORS[group] || '#374151';
}

/* 세부 내용 생성 함수 */
function generateDetailData(row) {
  const ips = ['192.168.0.1', '10.0.0.15', '172.16.1.100', '192.168.1.50', '10.1.1.25'];
  const oses = ['Windows 10', 'Windows 11', 'macOS', 'Ubuntu'];
  const computers = ['DESKTOP-TR03E35', 'LAPTOP-ABC123', 'WORKSTATION-XYZ', 'PC-DEF456'];
  const urls = ['https://chatgpt.com/', 'https://claude.ai/', 'https://bard.google.com/', 'https://www.bing.com/chat'];
  const browsers = ['Chrome', 'Firefox', 'Safari', 'Edge'];
  const llms = ['GPT', 'Claude', 'Bard', 'Copilot'];
  
  const hash = row.emp.charCodeAt(0) + row.date.charCodeAt(5);
  return {
    ip: ips[hash % ips.length],
    os: oses[hash % oses.length],
    computer: computers[hash % computers.length],
    url: urls[hash % urls.length],
    browser: browsers[hash % browsers.length],
    llm: llms[hash % llms.length]
  };
}

/* 팝업 열기 */
function openDetailModal(row) {
  const detail = generateDetailData(row);
  
  // 상태 스타일링
  const statusEl = $('#detail-status');
  statusEl.textContent = row.status;
  statusEl.style.color = row.status === '성공' ? '#059669' : '#dc2626';
  
  $('#detail-emp').textContent = row.emp || '-';
  $('#detail-ip').textContent = detail.ip;
  $('#detail-os').textContent = detail.os;
  $('#detail-computer').textContent = detail.computer;
  $('#detail-url').textContent = detail.url;
  $('#detail-browser').textContent = detail.browser;
  $('#detail-llm').textContent = detail.llm;
  $('#detail-source').textContent = row.source;
  
  // 개인정보 유형 칩 스타일링
  const typesEl = $('#detail-types');
  if (row.types && row.types.length > 0) {
    typesEl.innerHTML = row.types.map(type => 
      `<span style="display:inline-block;background:${getTypeColor(type)};color:${getTypeTextColor(type)};padding:2px 8px;border-radius:12px;font-size:12px;margin:2px 4px 2px 0;font-weight:700;">${type}</span>`
    ).join('');
  } else {
    typesEl.textContent = '-';
  }
  
  // 검증 결과 섭션 표시/숨김
  const validationSection = $('#validation-section');
  const validationEl = $('#detail-validation');
  const validationTypes = ['주민등록번호', '카드번호'];
  const hasValidationType = row.types && row.types.some(type => validationTypes.includes(type));
  
  if (hasValidationType) {
    const validationResults = row.types.filter(type => validationTypes.includes(type))
      .map(type => {
        const status = row.status === '성공' ? '성공' : '실패';
        const bgColor = status === '성공' ? 'rgba(16,185,129,0.15)' : 'rgba(239,68,68,0.15)';
        const textColor = status === '성공' ? '#059669' : '#dc2626';
        return `<span style="display:inline-block;background:${bgColor};color:${textColor};padding:2px 8px;border-radius:12px;font-size:12px;margin:2px 4px 2px 0;font-weight:700;">${type}-${status}</span>`;
      }).join('');
    validationEl.innerHTML = validationResults;
  } else {
    validationEl.textContent = '-';
  }
  validationSection.style.display = 'block';
  
  // 실패 사유 섭션 표시/숨김
  const reasonSection = $('#reason-section');
  const reasonEl = $('#detail-reason');
  if (row.reason && row.reason.trim()) {
    reasonEl.textContent = row.reason;
    reasonSection.style.display = 'block';
  } else {
    reasonSection.style.display = 'none';
  }
  
  $('#detailModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

/* 팝업 닫기 */
function closeDetailModal() {
  $('#detailModal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

// 테이블 렌더
function renderRows(rows){
  const $rows = $('#rows');
  const $empty = $('#empty');
  const $summary = $('#summary');
  $rows.innerHTML='';
  if(rows.length===0){
    $empty.hidden = false;
  } else {
    $empty.hidden = true;
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.addEventListener('click', () => openDetailModal(r));
      const chips = (r.types||[]).map(t=>`<span class="chip" style="background:${getTypeColor(t)};color:${getTypeTextColor(t)};font-weight:700;">${t}</span>`).join(' ');
      tr.innerHTML = `
        <td style="text-align:center;"><span class="status ${r.status==='성공'?'ok':'fail'}">${r.status}</span></td>
        <td style="text-align:center;">${r.date}</td>
        <td style="text-align:center;">${r.emp || '-'}</td>
        <td style="text-align:center;"><div class="chips">${chips}</div></td>
        <td style="text-align:center;">${r.source}</td>
        <td style="text-align:center;">${r.filename||'-'}</td>
        <td style="text-align:center;">${r.reason||''}</td>`;
      $rows.appendChild(tr);
    });
  }
  $summary.textContent = `총 ${rows.length}건`;
}

// Chart.js 파이차트(성공만 집계)
let pieChartInstance = null;

function renderChart(rows){
  const keys = ["전화번호","이메일","주민등록번호","카드번호","IP 주소","생년월일"];
  const counts = Object.fromEntries(keys.map(k=>[k,0]));
  rows.forEach(r=>{
    if (r.status === '성공') (r.types||[]).forEach(t => { if (counts.hasOwnProperty(t)) counts[t]++; });
  });

  const data = keys.map(k=>counts[k]);
  const filteredData = [];
  const filteredLabels = [];
  
  for(let i=0;i<keys.length;i++){
    if(data[i] > 0){
      filteredData.push(data[i]);
      filteredLabels.push(keys[i]);
    }
  }

  if(pieChartInstance) {
    pieChartInstance.destroy();
  }

  const ctx = document.getElementById('pieChart').getContext('2d');
  pieChartInstance = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: filteredLabels,
      datasets: [{
        data: filteredData,
        backgroundColor: ["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#14b8a6"]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 12,
            font: { size: 11 }
          }
        },
        datalabels: {
          color: '#fff',
          formatter: (value, ctx) => {
            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = ((value / total) * 100).toFixed(1);
            return percentage + '%';
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

// 초기화
function resetFilters(){
  $('#from').value=''; $('#to').value=''; $('#type').value=''; $('#source').value='';
  $('#status').value=''; $('#emp').value=''; $('#q').value=''; $('#quickDesc').textContent='';
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  applyFilters();
}

document.querySelectorAll('.pill').forEach(btn=> btn.addEventListener('click', ()=> setQuickRange(btn.dataset.range)));
$('#applyBtn').addEventListener('click', applyFilters);
$('#resetBtn').addEventListener('click', resetFilters);
document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.target.id==='q' || e.target.id==='emp')) applyFilters(); });

// 오늘 날짜 자동 설정
function setTodayDate() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  const todayStr = `${year}-${month}-${day}`;
  document.getElementById('from').value = todayStr;
  document.getElementById('to').value = todayStr;
}

// 페이지 로드 시 오늘 날짜 설정
document.addEventListener('DOMContentLoaded', function() {
  setTodayDate();
  // 오늘 범위 표시
  const today = new Date();
  const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
  document.getElementById('quickDesc').textContent = `· 오늘: ${todayStr} ~ ${todayStr}`;
  // 오늘 버튼 활성화
  document.querySelector('.pill[data-range="today"]').classList.add('active');
  // 필터 적용
  applyFilters();
});

// 화면 크기 변경 시 차트 업데이트
window.addEventListener('resize', () => {
  if (pieChartInstance) {
    pieChartInstance.resize();
  }
});

// 네비게이션 활성화
document.addEventListener('DOMContentLoaded', function() {
  const navLinks = document.querySelectorAll('.pm-nav a');
  navLinks[2].classList.add('active'); // 개인정보 유형별 현황 버튼 활성화
});

/* 모달 이벤트 리스너 */
document.addEventListener('DOMContentLoaded', function() {
  $('#closeModal').addEventListener('click', closeDetailModal);
  $('#detailModal').addEventListener('click', function(e) {
    if (e.target === this) closeDetailModal();
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeDetailModal();
  });
});
</script>

<!-- (선택) 우측 상단 유저 박스 -->
<div class="pm-userbox" role="group" aria-label="사용자 메뉴">
  <span class="emp" title="사번"><span class="dot" aria-hidden="true"></span> A1023</span>
  <button type="button" class="logout" onclick="location.href='login.html'">로그아웃</button>
</div>
</body>
</html>
