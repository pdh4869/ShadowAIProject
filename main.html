<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>개인정보 탐지 대시보드</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  

<link rel="stylesheet" href="assets/css/common.css">
<link rel="stylesheet" href="assets/page-css/main.page.css">
<style>
  .grid.indicators{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px;margin-bottom:24px;}
  .panel{background:#ffffff;border:1px solid #e2e8f0;border-radius:16px;padding:16px;box-shadow:0 5px 20px rgba(15,23,42,.05);cursor:pointer;}
  .panel h2{margin:0 0 8px 0;font-size:16px;}
  .small{color:#475569;font-size:12px;margin:0 0 8px 0;}
  .ind-val{display:flex;justify-content:space-between;align-items:baseline;margin-top:8px;}
  .ind-val .num{font-size:28px;font-weight:800;}
  .ind-val .delta{font-size:12px;font-weight:700;}
  .delta.ok{color:#16a34a;}
  .delta.warn{color:#d97706;}
  .delta.bad{color:#dc2626;}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid #e2e8f0;font-size:12px;color:#334155;}
  .tbl{width:100%;border-collapse:collapse;font-size:12px}
  .tbl th,.tbl td{border-bottom:1px solid #e2e8f0;padding:7px 5px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tbl th{font-weight:600}
</style></head>
<body>
  <div class="brandbar" onclick="location.href='main.html'" style="cursor:pointer"><div class="dot"></div> Privacy Monitor</div>
  <div class="pm-container">
    <div class="page-title">개인정보 탐지 대시보드</div>
    <div class="pm-navwrap">
      <nav class="pm-nav" aria-label="주요 메뉴">
        <a href="#" onclick="location.href='detection_details.html'">탐지 현황</a>
        <a href="#" onclick="location.href='detection_type.html'">탐지 유형</a>
        <a href="#" onclick="location.href='personal_information_type.html'">개인정보 유형</a>
        <a href="#" onclick="location.href='account_management.html'">계정 관리</a>
      </nav>
    </div>

    <div class="max-w-6xl mx-auto p-4">
    <!-- Indicator cards (3) -->
    <section class="grid indicators" id="cards">
      <div class="panel" data-detail="total">
        <h2>총 탐지 수 <span class="chip">운영</span></h2>
        <div class="small">기간 내 PII 탐지 건수</div>
        <div class="ind-val"><div class="num" id="totalNum">0</div><div class="delta" id="totalDelta">0%</div></div>
      </div>
      <div class="panel" data-detail="highrisk">
        <h2>고위험 PII 비중 <span class="chip">위험지표</span></h2>
        <div class="small">주민/외국인/여권/면허/카드/계좌</div>
        <div class="ind-val"><div class="num" id="highRiskNum">0%</div><div class="delta" id="highRiskDelta">0%</div></div>
      </div>
      <div class="panel" data-detail="valid">
        <h2>검증 통과율 <span class="chip">품질지표</span></h2>
        <div class="small">Luhn / 체크섬 통과율</div>
        <div class="ind-val"><div class="num" id="validNum">0%</div><div class="delta" id="validDelta">0%</div></div>
      </div>
    </section>
    
    <!-- 시간 추이 그래프 -->
    <section class="panel" data-detail="trend" style="margin-bottom:24px;">
      <h2>시간 추이(일별)</h2>
      <div style="height:220px;position:relative;">
        <canvas id="trendChart"></canvas>
      </div>
      <div class="legend" style="display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:#475569;margin-top:8px;">
        <span class="key" style="display:inline-flex;align-items:center;gap:6px;"><span class="box" style="width:10px;height:10px;border-radius:2px;background:#2563eb;border:1px solid #0001;"></span>총탐지</span>
        <span class="key" style="display:inline-flex;align-items:center;gap:6px;"><span class="box" style="width:10px;height:10px;border-radius:2px;background:#16a34a;border:1px solid #0001;"></span>고위험</span>
        <span class="key" style="display:inline-flex;align-items:center;gap:6px;"><span class="box" style="width:10px;height:10px;border-radius:2px;background:#dc2626;border:1px solid #0001;"></span>탐지실패</span>
      </div>
    </section>
    
    <section class="grid grid-cols-2 gap-3 mb-4">
        <div class="bg-white rounded shadow" style="padding:16px;display:flex;flex-direction:column;justify-content:center;height:100%;">
          <div style="display:flex;align-items:baseline;gap:12px;margin:0 0 8px 0;flex-wrap:wrap;">
            <h2 style="margin:0;font-size:16px;">사용자별 탐지 빈도 (TOP 5)</h2>
            <p class="text-xs text-gray-700" style="margin:0;" id="contribTimestamp"></p>
          </div>
          <div style="display:flex;justify-content:center;align-items:center;flex:1;">
            <table class="tbl" id="contribTable">
              <thead><tr><th>대상</th><th>탐지 수</th><th>고위험%</th></tr></thead>
              <tbody id="contribTbody"></tbody>
            </table>
          </div>
        </div>
        <div class="bg-white rounded shadow" style="padding:16px;display:flex;flex-direction:column;justify-content:center;height:100%;">
          <div style="display:flex;align-items:baseline;gap:12px;margin:0 0 8px 0;flex-wrap:wrap;">
            <h2 style="margin:0;font-size:16px;">금일 탐지 유형</h2>
            <p class="text-xs text-gray-700" style="margin:0;">총 건수: <strong><span id="todayTotal">0</span></strong></p>
          </div>
          <div style="display:flex;justify-content:center;align-items:center;flex:1;">
            <table class="tbl" id="todayTypeTable">
              <thead><tr><th>유형</th><th>건수</th></tr></thead>
              <tbody id="todayTypeTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="grid grid-cols-2 gap-3 mb-4">
        <div class="bg-white rounded shadow" style="padding:16px;">
          <h2 style="margin:0 0 8px 0;font-size:16px;">탐지 유형별 분포</h2>
          <div style="width: 270px; height: 270px; margin: 0 auto;"><canvas id="chartSourcePie"></canvas></div>
        </div>
        <div class="bg-white rounded shadow" style="padding:16px;">
          <div style="display:flex;align-items:baseline;gap:12px;margin:0 0 8px 0;flex-wrap:wrap;">
            <h2 style="margin:0;font-size:16px;">탐지 실패</h2>
            <p class="text-xs text-gray-700" style="margin:0;">총 실패: <strong>3</strong></p>
          </div>
          <ul class="mt-1 text-xs text-gray-600 space-y-1" style="padding-left: 0; margin-left: 0;">
            <li style="list-style: none;">• 2025-09-20 — 사번: A1023 / secret.pdf (암호화 파일)</li>
            <li style="list-style: none;">• 2025-09-21 — 사번: A1138 / test.docx (손상 파일)</li>
            <li style="list-style: none;">• 2025-09-22 — 사번: B2047 / data.xlsx (빈 파일)</li>
          </ul>
        </div>
      </section>
    </div>
  </div>

  <!-- 우측 상단 유저 박스 -->
  <div class="pm-userbox" role="group" aria-label="사용자 메뉴">
    <span class="emp" title="사번"><span class="dot" aria-hidden="true"></span> A1023</span>
    <button type="button" class="logout" onclick="location.href='login.html'">로그아웃</button>
  </div>

  <script>
    // 오늘 기준 7일간 시간 추이 데이터 생성
    const generateTrendData = () => {
      const data = [];
      const today = new Date();
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        data.push({
          date: dateStr,
          total: Math.floor(Math.random() * 30) + 20,
          highRisk: Math.floor(Math.random() * 15) + 5,
          failed: Math.floor(Math.random() * 5) + 1
        });
      }
      return data;
    };
    const trendData = generateTrendData();
    
    // 시간 추이 그래프
    new Chart(document.getElementById("trendChart"), {
      type: "line",
      data: {
        labels: trendData.map(d => d.date.slice(5)),
        datasets: [
          { label: "총탐지", data: trendData.map(d => d.total), borderColor: "#2563eb", backgroundColor: "rgba(37,99,235,0.1)", fill: true, tension: 0.3 },
          { label: "고위험", data: trendData.map(d => d.highRisk), borderColor: "#16a34a", backgroundColor: "rgba(22,163,74,0.1)", fill: false, tension: 0.3 },
          { label: "탐지실패", data: trendData.map(d => d.failed), borderColor: "#dc2626", backgroundColor: "rgba(220,38,38,0.1)", fill: false, tension: 0.3 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });

    // 기존 차트들
    const detectionsOverTime = [
      { date: "2025-09-18", count: 3 },
      { date: "2025-09-19", count: 7 },
      { date: "2025-09-20", count: 5 },
      { date: "2025-09-21", count: 8 },
      { date: "2025-09-22", count: 4 },
    ];
    
    // 사용자 기여도 데이터 (사번만)
    const contribData = [
      { name: "A1023", count: 45, highRisk: 12 },
      { name: "S0001", count: 38, highRisk: 8 },
      { name: "B2047", count: 32, highRisk: 15 },
      { name: "A1138", count: 28, highRisk: 6 },
      { name: "B2099", count: 25, highRisk: 9 }
    ];

    const sourceStats = [
      { source: "PDF", count: 50 },
      { source: "DOCX", count: 30 },
      { source: "XLSX", count: 22 },
      { source: "TXT", count: 18 },
      { source: "TEXT", count: 25 }
    ];
    const totalSources = sourceStats.reduce((sum, s) => sum + s.count, 0);

    new Chart(document.getElementById("chartDetectionsOverTime"), {
      type: "line",
      data: {
        labels: detectionsOverTime.map(d => d.date),
        datasets: [{ label: "탐지 건수", data: detectionsOverTime.map(d => d.count), fill: true, backgroundColor: "rgba(54, 162, 235, 0.3)", borderColor: "rgba(54, 162, 235, 1)", tension: 0.3 }]
      },
      options: { plugins: { legend: { display: false } } }
    });
    // 사용자 기여도 테이블 생성 (사번만)
    (function(){
      const tbody = document.getElementById("contribTbody");
      contribData.forEach(item => {
        const highRiskPercent = Math.round((item.highRisk / item.count) * 100);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.name}</td><td>${item.count.toLocaleString('ko-KR')}</td><td>${highRiskPercent}%</td>`;
        tbody.appendChild(tr);
      });
      
      // 현재 시간 표시
      const now = new Date();
      const timestamp = now.getFullYear() + '.' + 
                       String(now.getMonth() + 1).padStart(2, '0') + '.' + 
                       String(now.getDate()).padStart(2, '0') + ' ' + 
                       String(now.getHours()).padStart(2, '0') + ':' + 
                       String(now.getMinutes()).padStart(2, '0') + ' 기준';
      document.getElementById('contribTimestamp').textContent = timestamp;
    })();
    new Chart(document.getElementById("chartSourcePie"), {
      type: "pie",
      data: { labels: sourceStats.map(s => s.source), datasets: [{ data: sourceStats.map(s => s.count) }] },
      options: { plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } }, datalabels: { color: '#fff', formatter: (v) => ((v/totalSources)*100).toFixed(1)+'%' } } },
      plugins: [ChartDataLabels]
    });

    // 금일 탐지 유형 데이터
    (function(){
      const todayTypeStats = [
        { type: "전화번호", count: 10 },
        { type: "이메일", count: 8 },
        { type: "주민등록번호", count: 5 },
        { type: "카드번호", count: 3 },
        { type: "IP 주소", count: 2 }
      ];
      const tbody = document.getElementById("todayTypeTbody");
      const totalSpan = document.getElementById("todayTotal");
      const total = todayTypeStats.reduce((a,b)=>a+b.count,0);
      tbody.innerHTML = todayTypeStats.map(r=>`<tr class="border-t"><td class="py-1">${r.type}</td><td>${r.count}</td></tr>`).join('');
      totalSpan.textContent = total;
    })();
    
    // 통계 카드 데이터 업데이트
    (function(){
      const todayTypeStats = [
        { type: "전화번호", count: 10, isHighRisk: false, validCount: 9 },
        { type: "이메일", count: 8, isHighRisk: false, validCount: 7 },
        { type: "주민등록번호", count: 5, isHighRisk: true, validCount: 4 },
        { type: "카드번호", count: 3, isHighRisk: true, validCount: 3 },
        { type: "IP 주소", count: 2, isHighRisk: false, validCount: 2 }
      ];
      const todayTotal = todayTypeStats.reduce((a,b)=>a+b.count,0);
      const highRiskCount = todayTypeStats.filter(item => item.isHighRisk).reduce((a,b)=>a+b.count,0);
      const validCount = todayTypeStats.reduce((a,b)=>a+b.validCount,0);
      const highRiskRatio = ((highRiskCount / todayTotal) * 100).toFixed(1);
      const validRatio = ((validCount / todayTotal) * 100).toFixed(1);
      
      const stats = {
        total: { num: todayTotal, delta: 12.5 },
        highRisk: { num: parseFloat(highRiskRatio), delta: 3.2 },
        valid: { num: parseFloat(validRatio), delta: 5.1 }
      };
      
      document.getElementById('totalNum').textContent = stats.total.num;
      const totalDelta = document.getElementById('totalDelta');
      totalDelta.textContent = (stats.total.delta > 0 ? '+' : '') + stats.total.delta + '%';
      totalDelta.className = 'delta ' + (stats.total.delta > 0 ? 'ok' : 'bad');
      
      document.getElementById('highRiskNum').textContent = stats.highRisk.num + '%';
      const riskDelta = document.getElementById('highRiskDelta');
      riskDelta.textContent = (stats.highRisk.delta > 0 ? '+' : '') + stats.highRisk.delta + '%';
      riskDelta.className = 'delta ' + (stats.highRisk.delta > 0 ? 'bad' : 'ok');
      
      document.getElementById('validNum').textContent = stats.valid.num + '%';
      const validDelta = document.getElementById('validDelta');
      validDelta.textContent = (stats.valid.delta > 0 ? '+' : '') + stats.valid.delta + '%';
      validDelta.className = 'delta ' + (stats.valid.delta > 0 ? 'ok' : 'bad');
    })();
  </script>
</body>
</html>