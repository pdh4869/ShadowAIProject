{% extends "base.html" %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='page-css/detection_details.page.css') }}">
{% endblock %}

{% block content %}
    <div class="max-w-6xl mx-auto p-4">
    <section class="card" aria-label="필터">
      <div class="quick" aria-label="빠른 기간 선택">
        <button class="pill" data-range="today">오늘</button>
        <button class="pill" data-range="lastweek">지난 주</button>
        <button class="pill" data-range="lastmonth">지난 달</button>
        <span class="muted quick-desc" id="quickDesc"></span>
      </div>
      <div class="filters">
        <div class="field">
          <label for="from">시작 일자</label>
          <input type="date" id="from" value="{{ request.args.get('from', '') }}" />
        </div>
        <div class="field">
          <label for="to">종료 일자</label>
          <input type="date" id="to" value="{{ request.args.get('to', '') }}" />
        </div>
        <div class="field">
          <label for="source">탐지 유형</label>
          <select id="source">
            <option value="">전체</option>
            {% for ft in file_types %}
            <option value="{{ ft.type_name }}" {% if request.args.get('source') == ft.type_name %}selected{% endif %}>
              {{ ft.type_name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="field">
          <label for="status">상태</label>
          <select id="status">
            <option value="">전체</option>
            <option value="성공" {% if request.args.get('status') == '성공' %}selected{% endif %}>성공</option>
            <option value="실패" {% if request.args.get('status') == '실패' %}selected{% endif %}>실패</option>
          </select>
        </div>
        <div class="status-search-row">
          <div class="field">
            <label for="ip_address">IP 주소</label>
            <input id="ip_address" placeholder="예: 192.168.1.1" value="{{ request.args.get('ip_address', '') }}" />
          </div>
          <div class="field search">
            <label for="q">검색(파일명/URL/사유)</label>
            <input id="q" placeholder="예: report.pdf, chatgpt.com..." value="{{ request.args.get('q', '') }}" />
          </div>
        </div>
      </div>
      <div class="toolbar">
        <div class="muted" id="summary">총 {{ logs|length }}건</div>
        <div class="actions">
          <button class="btn ghost" id="resetBtn">초기화</button>
          <button class="btn primary" id="applyBtn">적용</button>
        </div>
      </div>
    </section>

    <section class="card chart-card" aria-label="탐지 유형 그래프">
      <h2 class="chart-title">탐지 유형 분포</h2>
      <div class="chart-height">
        <canvas id="barChart"></canvas>
      </div>
    </section>

    <section class="card mt-16" aria-label="목록">
      <div class="table-wrap">
        <table aria-describedby="summary">
          <thead>
            <tr>
              <th class="table-header-100">상태</th>
              <th class="table-header-120">일자</th>
              <th class="table-header-110">IP</th>
              <th class="table-header-220">개인정보 유형</th>
              <th class="table-header-140">탐지 유형</th>
              <th class="table-header-center">파일명</th>
              <th class="table-header-center">실패 사유</th>
            </tr>
          </thead>
          <tbody id="rows">
            {% for log in logs %}
            <tr style="cursor:pointer" data-log-id="{{ log.id }}">
              <td style="text-align:center;">
                <span class="status {{ 'ok' if log.status == '성공' else 'fail' }}">{{ log.status }}</span>
              </td>
              <td style="text-align:center;">{{ log.timestamp }}</td>
              <td style="text-align:center;">{{ log.ip_address or '-' }}</td>
              <td style="text-align:center;">
                <div class="chips">
                  {% for pii_type in log.pii_types_names %}
                  <span class="chip">{{ pii_type }}</span>
                  {% endfor %}
                </div>
              </td>
              <td style="text-align:center;">{{ log.file_type_name or '-' }}</td>
              <td style="text-align:center;">{{ log.filename or '-' }}</td>
              <td style="text-align:center;">{{ log.reason or '' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="empty" id="empty" {% if logs|length > 0 %}hidden{% endif %}>조건에 맞는 결과가 없습니다.</div>
    </section>
    </div>

    <div id="detailModal" class="modal">
      <div class="modal-content card">
        <div class="modal-header">
          <div>
            <h3>탐지 결과 상세</h3>
            <button id="closeModal" class="modal-close-btn">&times;</button>
          </div>
        </div>
        <div class="modal-body">
          <div class="detail-sections">
            <div class="detail-section">
              <h4>기본 정보</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <div>상태</div>
                  <div id="detail-status">-</div>
                </div>
                <div class="detail-item">
                  <div>IP</div>
                  <div id="detail-emp">-</div>
                </div>
                <div class="detail-item wide">
                  <div>일자</div>
                  <div id="detail-date">-</div>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h4>시스템 정보</h4>
              <div class="detail-grid">
                <div class="detail-item wide">
                  <div>IP 주소</div>
                  <div id="detail-ip">-</div>
                </div>
                <div class="detail-item wide">
                  <div>운영체제</div>
                  <div id="detail-os">-</div>
                </div>
                <div class="detail-item fit-content">
                  <div>컴퓨터 이름</div>
                  <div id="detail-computer">-</div>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h4>웹 정보</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <div>브라우저</div>
                  <div id="detail-browser">-</div>
                </div>
                <div class="detail-item">
                  <div>LLM</div>
                  <div id="detail-llm">-</div>
                </div>
                <div class="detail-item fit-content max-width">
                  <div>URL</div>
                  <div id="detail-url" class="url-text">-</div>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h4>탐지 정보</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <div>탐지 유형</div>
                  <div id="detail-source">-</div>
                </div>
                <div class="detail-item padded fit-content" id="filename-section">
                  <div>파일명</div>
                  <div id="detail-filename" class="break-all">-</div>
                </div>
                <div class="detail-item padded fit-content">
                  <div>탐지 결과</div>
                  <div id="detail-types">-</div>
                </div>
                <div class="detail-item padded fit-content" id="validation-section">
                  <div>검증 결과</div>
                  <div id="detail-validation">-</div>
                </div>
                <div class="detail-item padded fit-content">
                  <div>개인 식별 의심</div>
                  <div id="detail-suspicious">-</div>
                </div>
                <div class="detail-item padded fit-content" id="reason-section">
                  <div>실패 사유</div>
                  <div id="detail-reason">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Flask에서 전달된 데이터를 JavaScript 변수로 변환
      window.DETECTION_LOGS = {{ DETECTION_LOGS|tojson|safe }};
      window.BAR_CHART_DATA = {{ bar_chart_data|tojson|safe }};
    </script>
{% endblock %}

{% block page_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='page-js/detection_details.page.js') }}"></script>
{% endblock %}