{% extends "base.html" %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='page-css/personal_information_type.page.css') }}">
{% endblock %}

{% block title %}개인정보 유형별 현황{% endblock %}
{% block page_title %}개인정보 유형별 현황{% endblock %}

{% block content %}
    <div class="max-w-6xl mx-auto p-4">
    <section class="card" aria-label="필터">
      <div class="quick" aria-label="빠른 기간 선택">
        <button class="pill" data-range="today">오늘</button>
        <button class="pill" data-range="lastweek">지난 주</button>
        <button class="pill" data-range="lastmonth">지난 달</button>
        <span class="muted quick-desc" id="quickDesc"></span>
      </div>
      <div class="filters">
        <div class="field">
          <label for="from">시작일자</label>
          <input type="date" id="from" value="{{ request.args.get('from', '') }}" />
        </div>
        <div class="field">
          <label for="to">종료일자</label>
          <input type="date" id="to" value="{{ request.args.get('to', '') }}" />
        </div>
        <div class="field">
          <label for="type">개인정보 유형</label>
          <select id="type">
            <option value="">전체</option>
            <option value="name" {% if request.args.get('type') == 'name' %}selected{% endif %}>이름</option>
            <option value="phone" {% if request.args.get('type') == 'phone' %}selected{% endif %}>전화번호</option>
            <option value="email" {% if request.args.get('type') == 'email' %}selected{% endif %}>이메일</option>
            <option value="birth" {% if request.args.get('type') == 'birth' %}selected{% endif %}>생년월일</option>
            <option value="ssn" {% if request.args.get('type') == 'ssn' %}selected{% endif %}>주민등록번호</option>
            <option value="alien_registration" {% if request.args.get('type') == 'alien_registration' %}selected{% endif %}>외국인등록번호</option>
            <option value="driver_license" {% if request.args.get('type') == 'driver_license' %}selected{% endif %}>운전면허번호</option>
            <option value="passport" {% if request.args.get('type') == 'passport' %}selected{% endif %}>여권번호</option>
            <option value="account" {% if request.args.get('type') == 'account' %}selected{% endif %}>계좌번호</option>
            <option value="card" {% if request.args.get('type') == 'card' %}selected{% endif %}>카드번호</option>
            <option value="ip" {% if request.args.get('type') == 'ip' %}selected{% endif %}>IP</option>
            <option value="position" {% if request.args.get('type') == 'position' %}selected{% endif %}>직책</option>
            <option value="org" {% if request.args.get('type') == 'org' %}selected{% endif %}>조직/기관</option>
            <option value="face_image" {% if request.args.get('type') == 'face_image' %}selected{% endif %}>얼굴이미지</option>
          </select>
        </div>
        <div class="field">
          <label for="source">탐지 유형</label>
          <select id="source">
            <option value="">전체</option>
            <option value="텍스트" {% if request.args.get('source') == '텍스트' %}selected{% endif %}>텍스트</option>
            <option value="PDF" {% if request.args.get('source') == 'PDF' %}selected{% endif %}>PDF</option>
            <option value="DOCX/DOC" {% if request.args.get('source') == 'DOCX/DOC' %}selected{% endif %}>DOCX/DOC</option>
            <option value="HWPX/HWP" {% if request.args.get('source') == 'HWPX/HWP' %}selected{% endif %}>HWPX/HWP</option>
            <option value="XLSX/XLS" {% if request.args.get('source') == 'XLSX/XLS' %}selected{% endif %}>XLSX/XLS</option>
            <option value="PPTX" {% if request.args.get('source') == 'PPTX' %}selected{% endif %}>PPTX</option>
            <option value="TXT" {% if request.args.get('source') == 'TXT' %}selected{% endif %}>TXT</option>
            <option value="PNG" {% if request.args.get('source') == 'PNG' %}selected{% endif %}>PNG</option>
            <option value="JPG/JPEG" {% if request.args.get('source') == 'JPG/JPEG' %}selected{% endif %}>JPG/JPEG</option>
            <option value="BMP" {% if request.args.get('source') == 'BMP' %}selected{% endif %}>BMP</option>
            <option value="WEBP" {% if request.args.get('source') == 'WEBP' %}selected{% endif %}>WEBP</option>
            <option value="GIF" {% if request.args.get('source') == 'GIF' %}selected{% endif %}>GIF</option>
            <option value="TIFF" {% if request.args.get('source') == 'TIFF' %}selected{% endif %}>TIFF</option>
          </select>
        </div>
        <div class="status-search-row">
          <div class="field">
            <label for="status">상태</label>
            <select id="status">
              <option value="">전체</option>
              {% for status_opt in status_options %}
              <option value="{{ status_opt }}" {% if request.args.get('status') == status_opt %}selected{% endif %}>
                {{ status_opt }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="field search">
            <label for="q">검색</label>
            <input id="q" placeholder="예: 192.168.1.1, Windows, PC-001, GPT-4, report.pdf..." value="{{ request.args.get('q', '') }}" />
          </div>
        </div>
      </div>
      <div class="toolbar">
        <div class="muted" id="summary">총 {{ logs|length }}건</div>
        <div class="actions">
          <button class="btn ghost" id="resetBtn">초기화</button>
          <button class="btn primary" id="applyBtn">적용</button>
        </div>
      </div>
    </section>

    <section class="card chart-card" aria-label="개인정보 유형 그래프">
      <h2 class="chart-title">개인정보 유형 분포</h2>
      <div class="chart-height">
        <canvas id="barChart"></canvas>
      </div>
    </section>

    <section class="card mt-16" aria-label="목록">
      <div class="table-wrap">
        <table aria-describedby="summary">
          <thead>
            <tr>
              <th class="w-100 center">상태</th>
              <th class="w-120 center">일자</th>
              <th class="w-110 center">IP</th>
              <th class="w-220 center">개인정보 유형</th>
              <th class="w-140 center">소스 유형</th>
              <th class="center">파일명</th>
              <th class="center">실패 사유</th>
            </tr>
          </thead>
          <tbody id="rows">
             {% for log in logs %}
            <tr style="cursor:pointer" data-log-id="{{ log.id }}">
              <td style="text-align:center;">
                <span class="status {{ 'ok' if log.status == '성공' else 'fail' }}">{{ log.status }}</span>
              </td>
              <td style="text-align:center;">{{ log.timestamp }}</td>
              <td style="text-align:center;">{{ log.ip_address or '-' }}</td>
              <td style="text-align:center;">
                <div class="chips">
                  {% for pii_type in log.pii_types_names %}
                  <span class="chip">{{ pii_type }}</span>
                  {% endfor %}
                </div>
              </td>
              <td style="text-align:center;">{{ log.file_type_name or '-' }}</td>
              <td style="text-align:center;">{{ log.filename or '-' }}</td>
              <td style="text-align:center;">{{ log.reason or '' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="empty" id="empty" {% if logs|length > 0 %}hidden{% endif %}>조건에 맞는 결과가 없습니다.</div>
    </section>
    </div>

    {# 상세 모달은 그대로 유지 #}
    <div id="detailModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
      <div class="modal-content-custom card">
        <div class="modal-header-custom">
          <div class="modal-header-flex">
            <h3 class="modal-title">탐지 결과 상세</h3>
            <button id="closeModal" class="modal-close-btn">&times;</button>
          </div>
        </div>
        <div class="modal-body-custom">
          <div class="detail-sections">
            <div class="detail-section-custom">
              <h4 class="detail-section-title">기본 정보</h4>
              <div class="detail-grid-custom">
                <div class="detail-item-custom">
                  <div class="detail-item-label">상태</div>
                  <div id="detail-status" class="detail-item-value-bold">-</div>
                </div>
                <div class="detail-item-custom">
                  <div class="detail-item-label">IP</div>
                  <div id="detail-emp" class="detail-item-value">-</div>
                </div>
                <div class="detail-item-custom detail-item-wide">
                  <div class="detail-item-label">일자</div>
                  <div id="detail-date" class="detail-item-value">-</div>
                </div>
              </div>
            </div>
            
            <div class="detail-section-custom">
              <h4 class="detail-section-title">시스템 정보</h4>
              <div class="detail-grid-custom">
                <div class="detail-item-custom detail-item-wide">
                  <div class="detail-item-label">IP 주소</div>
                  <div id="detail-ip" class="detail-item-value">-</div>
                </div>
                <div class="detail-item-custom detail-item-wide">
                  <div class="detail-item-label">운영체제</div>
                  <div id="detail-os" class="detail-item-value">-</div>
                </div>
                <div class="detail-item-custom detail-item-fit">
                  <div class="detail-item-label">컴퓨터 이름</div>
                  <div id="detail-computer" class="detail-item-value">-</div>
                </div>
              </div>
            </div>
            
            <div class="detail-section-custom">
              <h4 class="detail-section-title">웹 정보</h4>
              <div class="detail-grid-custom">
                <div class="detail-item-custom">
                  <div class="detail-item-label">브라우저</div>
                  <div id="detail-browser" class="detail-item-value">-</div>
                </div>
                <div class="detail-item-custom">
                  <div class="detail-item-label">LLM</div>
                  <div id="detail-llm" class="detail-item-value">-</div>
                </div>
                <div class="detail-item-custom detail-item-fit" style="flex: 1 1 100%;">
                  <div class="detail-item-label">URL</div>
                  <div id="detail-url" class="detail-item-url">-</div>
                </div>
              </div>
            </div>
            
            <div class="detail-section-custom">
              <h4 class="detail-section-title">탐지 정보</h4>
              <div class="detail-grid-custom">
                <div class="detail-item-custom">
                  <div class="detail-item-label">탐지 유형</div>
                  <div id="detail-source" class="detail-item-value">-</div>
                </div>
                <div class="detail-item-custom detail-item-padded detail-item-fit" id="filename-section">
                  <div class="detail-item-label">파일명</div>
                  <div id="detail-filename" class="detail-item-filename">-</div>
                </div>
                <div class="detail-item-custom detail-item-padded detail-item-fit">
                  <div class="detail-item-label">탐지 결과</div>
                  <div id="detail-types" class="detail-item-value">-</div>
                </div>
                <div class="detail-item-custom detail-item-padded detail-item-fit" id="validation-section">
                  <div class="detail-item-label">검증 결과</div>
                  <div id="detail-validation" class="detail-item-value">-</div>
                </div>
                <div class="detail-item-custom detail-item-padded detail-item-fit">
                  <div class="detail-item-label">개인 식별 의심</div>
                  <div id="detail-suspicious" class="detail-item-value">-</div>
                </div>
                <div class="detail-item-custom detail-item-padded detail-item-fit" id="reason-section">
                  <div class="detail-item-label">실패 사유</div>
                  <div id="detail-reason" class="detail-item-filename">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    {# ⭐ Flask에서 전달하는 변수명에 맞게 window 변수 할당 추가 #}
    <script>
        window.DETECTION_LOGS = {{ logs|tojson|safe }};
        window.BAR_CHART_DATA = {{ pie_chart_data|tojson|safe }};
    </script>
{% endblock %}

{% block page_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='page-js/personal_information_type.page.js') }}"></script>
{% endblock %}