<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PII 탐지 모니터링 — 모의 데이터 v7 (라이트, 외부성 비중 제거)</title>
<style>
  :root{
    --bg:#f6f7fb; --panel:#ffffff; --panel-2:#f2f4f8; --text:#0f172a; --muted:#475569;
    --accent:#2563eb; --border:#e2e8f0; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:linear-gradient(180deg,#f8fafc,#f6f7fb);
    color:var(--text);
    font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  .container{max-width:1200px;margin:24px auto 80px;padding:0 16px;}
  header{
    display:grid;gap:12px;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px;
    box-shadow: 0 6px 24px rgba(15, 23, 42, .06);
  }
  header .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
  h1{margin:0 0 4px 0;font-size:20px}
  .sub{color:var(--muted);font-size:13px}
  label{font-size:12px;color:var(--muted)}
  select,input[type="number"],input[type="range"]{
    background:var(--panel-2);
    border:1px solid var(--border);
    color:var(--text);
    padding:8px 10px;border-radius:10px;min-width:140px;outline:none;
  }
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;}
  .grid{display:grid;gap:16px;margin-top:16px}
  .indicators{grid-template-columns: repeat(3, minmax(0,1fr));}
  .panel{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px;
    box-shadow: 0 5px 20px rgba(15, 23, 42, .05);
    cursor:pointer
  }
  .panel h2{margin:0 0 8px 0;font-size:16px}
  .small{color:var(--muted);font-size:12px;margin:0 0 8px 0}
  .ind-val{display:flex;justify-content:space-between;align-items:baseline;margin-top:8px}
  .ind-val .num{font-size:28px;font-weight:800}
  .ind-val .delta{font-size:12px;font-weight:700}
  .delta.ok{color:var(--ok)} .delta.warn{color:var(--warn)} .delta.bad{color:var(--bad)}
  .main-2col{grid-template-columns: 2fr 1fr;}
  .two-col{grid-template-columns: 1fr 1fr;}
  .footer-note{color:var(--muted);font-size:12px}
  canvas{
    width:100%;height:220px;
    background:repeating-linear-gradient(45deg,#f8fafc,#f8fafc 10px,#f2f4f8 10px,#f2f4f8 20px);
    border-radius:12px;border:1px dashed var(--border);cursor:pointer
  }
  .legend{display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:var(--muted);margin-top:8px}
  .key{display:inline-flex;align-items:center;gap:6px}
  .box{width:10px;height:10px;border-radius:2px;background:#94a3b8;border:1px solid #0001}
  .tbl{width:100%;border-collapse:collapse;font-size:13px}
  .tbl th,.tbl td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tbl th{color:var(--muted);font-weight:600}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid var(--border);font-size:12px;color:#334155}
  @media (max-width:1024px){.indicators{grid-template-columns:repeat(2,minmax(0,1fr));}.main-2col{grid-template-columns:1fr}.two-col{grid-template-columns:1fr}}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:#0007;opacity:0;pointer-events:none;transition:.15s}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-45%);min-width:320px;max-width:1100px;width:92%;
         background:var(--panel);border:1px solid var(--border);border-radius:16px;
         box-shadow:0 30px 80px rgba(15, 23, 42, .15);
         opacity:0;pointer-events:none;transition:.15s}
  .modal.open,.modal-backdrop.open{opacity:1;pointer-events:auto}
  .modal.open{transform:translate(-50%,-50%)}
  .modal header{display:flex;justify-content:space-between;align-items:center;background:transparent;border:none;box-shadow:none;padding:16px}
  .modal header h3{margin:0;font-size:18px}
  .modal .content{padding:0 16px 16px 16px;color:var(--text)}
  .close{background:#eef2ff;border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}
  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;color:#334155}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .toolbar input, .toolbar select{background:var(--panel-2);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:8px}
  .maxh{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff}
</style>
</head>
<body>
<div class="container">
  <header class="panel" style="cursor:default">
    <div>
      <h1>PII 탐지 모니터링 — 요약 지표 (리스크 · 품질 · 운영)</h1>
      <div class="sub">모의 데이터입니다. 요소를 클릭하면 상세 로그 팝업이 열립니다. (라이트 모드)</div>
    </div>
    <div class="row">
      <label>조회 기간
        <select id="range">
          <option>최근 7일</option>
          <option selected>최근 30일</option>
          <option>최근 90일</option>
        </select>
      </label>
      <label>범위
        <select>
          <option>부서</option>
          <option>사용자</option>
          <option selected>소스(파일명/URL/도메인)</option>
          <option>모델(GPT/Gemini)</option>
        </select>
      </label>
      <label>알림 민감도
        <input type="range" min="1" max="5" value="3">
      </label>
      <label>고위험 기준(%)
        <input type="number" value="30" min="0" max="100">
      </label>
      <label>체크섬 최소 통과(%)
        <input type="number" value="70" min="0" max="100">
      </label>
      <button class="btn" id="apply">적용</button>
    </div>
  </header>

  <!-- Indicator cards (3) -->
  <section class="grid indicators" id="cards">
    <div class="panel" data-detail="total">
      <h2>총 탐지 수 <span class="chip">운영</span></h2>
      <div class="small">기간 내 PII 탐지 건수</div>
      <div class="ind-val"><div class="num" id="totalNum">0</div><div class="delta" id="totalDelta">0%</div></div>
    </div>
    <div class="panel" data-detail="highrisk">
      <h2>고위험 PII 비중 <span class="chip">위험지표</span></h2>
      <div class="small">주민/외국인/여권/면허/카드/계좌</div>
      <div class="ind-val"><div class="num" id="highRiskNum">0%</div><div class="delta" id="highRiskDelta">0 pp</div></div>
    </div>
    <div class="panel" data-detail="valid">
      <h2>검증 통과율 <span class="chip">품질지표</span></h2>
      <div class="small">Luhn / 체크섬 통과율</div>
      <div class="ind-val"><div class="num" id="validNum">0%</div><div class="delta" id="validDelta">0 pp</div></div>
    </div>
  </section>

  <!-- Trend + Hour/Weekday bars (unchanged) -->
  <section class="grid main-2col">
    <div class="panel" data-detail="trend">
      <h2>시간 추이(일별)</h2>
      <canvas id="trend"></canvas>
      <div class="legend">
        <span class="key"><span class="box" style="background:#2563eb"></span>총탐지</span>
        <span class="key"><span class="box" style="background:#16a34a"></span>고위험</span>
        <span class="key"><span class="box" style="background:#d97706"></span>외부성</span>
      </div>
    </div>
    <div class="panel" style="cursor:default">
      <h2>시간대 / 요일 분포</h2>
      <div class="small">막대를 클릭하면 해당 구간 로그 팝업</div>
      <div style="display:grid;gap:12px">
        <div>
          <div class="small">시간대별(0–23시)</div>
          <canvas id="byHour" height="180" style="height:180px"></canvas>
        </div>
        <div>
          <div class="small">요일별(월–일)</div>
          <canvas id="byWeekday" height="180" style="height:180px"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- Top N + Contribution -->
  <section class="grid two-col">
    <div class="panel" data-detail="topsources">
      <h2>Top N 소스 (파일명 / URL / 도메인)</h2>
      <table class="tbl" id="topSources">
        <thead><tr><th>소스</th><th>탐지 수</th><th>고위험%</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="panel" data-detail="contrib">
      <h2>부서 / 사용자 기여도</h2>
      <table class="tbl" id="contrib">
        <thead><tr><th>대상</th><th>탐지 수</th><th>고위험%</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Model comparison -->
  <section class="grid" style="grid-template-columns:1fr">
    <div class="panel" data-detail="models">
      <h2>모델 비교 (GPT vs Gemini)</h2>
      <table class="tbl" id="models">
        <thead><tr><th>모델</th><th>탐지율</th><th>오탐율</th><th>체크섬 통과%</th><th>비용/1k</th></tr></thead>
        <tbody>
          <tr><td>GPT</td><td>92%</td><td>6%</td><td>78%</td><td>$2.10</td></tr>
          <tr><td>Gemini</td><td>89%</td><td>5%</td><td>75%</td><td>$1.70</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <p class="footer-note">
    모의 데이터입니다. 표준 타임존: Asia/Seoul
  </p>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="mb"></div>
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="mtitle">
  <header>
    <h3 id="mtitle">상세</h3>
    <div class="toolbar">
      <input id="search" placeholder="검색(소스·사용자·유형 등)" />
      <select id="piifilter">
        <option value="">PII 유형(전체)</option>
        <option>RRN</option><option>FRN</option><option>Passport</option><option>DL</option><option>Card</option><option>Account</option><option>Email</option><option>Phone</option>
      </select>
      <button class="btn" id="download">CSV 내보내기</button>
      <button class="close" id="mclose">닫기(ESC)</button>
    </div>
  </header>
  <div class="content" id="mcontent"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // ---------- Mock base data ----------
  function seedRandom(s){let x=Math.sin(s)*10000;return function(){x=Math.sin(x)*10000;return x-Math.floor(x);}}
  const rnd = seedRandom(123);
  const piiTypes = ['RRN','FRN','Passport','DL','Card','Account','Email','Phone'];
  const depts = ['Sales','R&D','Support','Ops','HR'];
  const users = ['u-10232','u-9981','u-7731','u-5520','u-3302'];
  const sources = [
    'backup_20251003.csv','s3://logs/app/2025-10-04/','https://share.example.com/report.html',
    'etl/export/batch_users.csv','cdn.example.com/public/','drive://team/docs/raw.csv','api/upload/attachments/'
  ];
  function pick(arr){return arr[Math.floor(rnd()*arr.length)]}
  function randInt(a,b){return Math.floor(a + rnd()*(b-a+1))}
  function luhnPass(){return rnd() > 0.28}
  function destScope(){return rnd() > 0.82 ? 'external' : 'internal'}
  // generate 600 logs for last 30 days
  const logs = Array.from({length:600}, (_,i)=>{
    const daysAgo = randInt(0,29);
    const hour = randInt(0,23);
    const date = new Date(Date.now() - daysAgo*86400000);
    date.setHours(hour, randInt(0,59), randInt(0,59), 0);
    const pii = pick(piiTypes);
    const isHigh = ['RRN','FRN','Passport','DL','Card','Account'].includes(pii);
    const src = pick(sources);
    const u = pick(users);
    const d = pick(depts);
    const model = rnd() > 0.5 ? 'GPT' : 'Gemini';
    const fp = Math.random().toString(36).slice(2,10) + Math.random().toString(36).slice(2,6);
    return {
      time: date,
      source: src,
      pii_type: pii,
      high: isHigh,
      dest: destScope(),
      model: model,
      checksum_pass: ['Card','Account','RRN','DL'].includes(pii) ? luhnPass() : null,
      user: u,
      dept: d,
      fingerprint: fp
    };
  }).sort((a,b)=>b.time - a.time);

  // ---------- KPIs from logs ----------
  const within = (days)=> logs.filter(l => (Date.now()-l.time.getTime())/86400000 <= days);
  const win = within(30);
  const last7 = within(7);
  const prev7 = logs.filter(l => (Date.now()-l.time.getTime())/86400000 > 7 && (Date.now()-l.time.getTime())/86400000 <= 14);

  const totalLast7 = last7.length;
  const totalPrev7 = prev7.length;
  const totalDelta = ((totalLast7 - totalPrev7)/Math.max(1,totalPrev7)*100).toFixed(1);

  const highLast7 = last7.filter(l=>l.high).length;
  const highPrev7 = prev7.filter(l=>l.high).length;
  const highShareNow = Math.round(highLast7/Math.max(1,totalLast7)*100);
  const highSharePrev = highPrev7/Math.max(1,totalPrev7)*100;
  const highShareDelta = (highShareNow - highSharePrev).toFixed(1);

  const checksumCandidates7 = last7.filter(l=>l.checksum_pass!==null);
  const validNow = Math.round(checksumCandidates7.filter(l=>l.checksum_pass).length/Math.max(1,checksumCandidates7.length)*100);
  const validDelta = -5.4; // fixed mock change

  // Fill cards
  function setDelta(el, val, unit){
    el.textContent = (val>0?'+':'') + val + (unit||'');
    el.classList.remove('ok','warn','bad');
    if(el.id==='validDelta'){ el.classList.add(val>=0?'ok':'bad'); }
    else if(el.id==='highRiskDelta'){ el.classList.add(val>0?'bad':'ok'); }
    else { el.classList.add(val>=0?'ok':'warn'); }
  }
  document.getElementById('totalNum').textContent = totalLast7.toLocaleString('ko-KR');
  setDelta(document.getElementById('totalDelta'), parseFloat(totalDelta), '%');
  document.getElementById('highRiskNum').textContent = highShareNow + '%';
  setDelta(document.getElementById('highRiskDelta'), parseFloat(highShareDelta), ' pp');
  document.getElementById('validNum').textContent = validNow + '%';
  setDelta(document.getElementById('validDelta'), validDelta, ' pp');

  // ---------- Charts (canvas) ----------
  function lineChart(canvas, series){
    const ctx = canvas.getContext('2d');
    const w = canvas.width = canvas.clientWidth * devicePixelRatio;
    const h = canvas.height = canvas.clientHeight * devicePixelRatio;
    const pad = 40 * devicePixelRatio;
    const maxY = Math.max(...series.flat());
    ctx.clearRect(0,0,w,h);
    ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.moveTo(pad, h-pad); ctx.lineTo(pad, pad); ctx.stroke();
    const colors = ['#2563eb','#16a34a','#d97706'];
    series.forEach((arr, si)=>{
      ctx.beginPath(); ctx.strokeStyle = colors[si]; ctx.lineWidth = 2*devicePixelRatio;
      arr.forEach((v,i)=>{
        const x = pad + (w-2*pad) * (i/(arr.length-1));
        const y = h - pad - ( v/Math.max(1,maxY) ) * (h-2*pad);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }); ctx.stroke();
    });
  }
  // rollup daily counts for 30d
  function rollup(arr, keyFn){
    const map = new Map();
    arr.forEach(l=>{
      const k = keyFn(l);
      map.set(k, (map.get(k)||0)+1);
    });
    return map;
  }
  const dayKey = (l)=>{const d=new Date(l.time); d.setHours(0,0,0,0); return d.getTime();}
  const allDays = Array.from({length:30}, (_,i)=>{const d=new Date();d.setHours(0,0,0,0);d.setDate(d.getDate()-29+i);return d.getTime();});
  const totalByDay = rollup(win, dayKey);
  const highByDay = rollup(win.filter(l=>l.high), dayKey);
  const extByDay = rollup(win.filter(l=>l.dest==='external'), dayKey);
  const seriesTotal = allDays.map(k=>totalByDay.get(k)||0);
  const seriesHigh = allDays.map(k=>highByDay.get(k)||0);
  const seriesExt = allDays.map(k=>extByDay.get(k)||0);
  lineChart(document.getElementById('trend'), [seriesTotal, seriesHigh, seriesExt]);

  // --------- Hour-of-day and Weekday bar charts ---------
  function barChart(canvas, values, labels, onClick){
    const ctx = canvas.getContext('2d');
    const w = canvas.width = canvas.clientWidth * devicePixelRatio;
    const h = canvas.height = canvas.clientHeight * devicePixelRatio;
    const pad = 36 * devicePixelRatio;
    const maxV = Math.max(...values, 1);
    const n = values.length;
    const bw = (w-2*pad)/n;
    ctx.clearRect(0,0,w,h);
    // axes
    ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.moveTo(pad, h-pad); ctx.lineTo(pad, pad/2); ctx.stroke();
    // bars
    ctx.fillStyle = '#2563eb';
    const hits = [];
    for(let i=0;i<n;i++){
      const v = values[i];
      const x = pad + i*bw + bw*0.1;
      const y = h - pad - (v/maxV)*(h-1.6*pad);
      const barw = bw*0.8;
      const barh = (v/maxV)*(h-1.6*pad);
      ctx.fillRect(x, y, barw, barh);
      hits.push({x, y, w: barw, h: barh, i});
      // labels
      ctx.fillStyle = '#334155';
      ctx.font = `${12*devicePixelRatio}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      const lab = labels[i];
      if(n<=8 || i%2===0){
        ctx.fillText(lab, x, h - pad + 14*devicePixelRatio);
      }
      ctx.fillStyle = '#2563eb';
    }
    // click handler
    canvas.onclick = (ev)=>{
      const rect = canvas.getBoundingClientRect();
      const mx = (ev.clientX - rect.left) * devicePixelRatio;
      const my = (ev.clientY - rect.top) * devicePixelRatio;
      const hit = hits.find(b => mx>=b.x && mx<=b.x+b.w && my>=b.y && my<=b.y+b.h);
      if(hit){ onClick(hit.i); }
    };
  }

  // build hour/weekday arrays from last 30d
  const byHourVals = Array.from({length:24}, ()=>0);
  const byWeekVals = Array.from({length:7}, ()=>0); // Mon=0..Sun=6
  win.forEach(l=>{
    byHourVals[l.time.getHours()]++;
    const dow=(l.time.getDay()+6)%7;
    byWeekVals[dow]++;
  });
  const hourLabels = Array.from({length:24}, (_,i)=>String(i).padStart(2,'0'));
  const weekLabels = ['월','화','수','목','금','토','일'];
  const byHourCanvas = document.getElementById('byHour');
  const byWeekCanvas = document.getElementById('byWeekday');

  // ---------- Modal infra (reused) ----------
  const mb = document.getElementById('mb');
  const modal = document.getElementById('modal');
  const mtitle = document.getElementById('mtitle');
  const mcontent = document.getElementById('mcontent');
  const search = document.getElementById('search');
  const piifilter = document.getElementById('piifilter');
  const downloadBtn = document.getElementById('download');
  document.getElementById('mclose').addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
  mb.addEventListener('click', closeModal);

  function openModal(title, rows){
    mtitle.textContent = title;
    renderLogs(rows);
    mb.classList.add('open'); modal.classList.add('open');
  }
  function closeModal(){ mb.classList.remove('open'); modal.classList.remove('open'); }

  let currentRows = [];
  function renderLogs(rows){
    currentRows = rows.slice(); // shallow copy
    const total = currentRows.length;
    const head = `
      <div class="mono" style="margin-bottom:6px">${total.toLocaleString('ko-KR')}건 표시 (상위 200건까지만 렌더링)</div>
      <div class="maxh"><table class="tbl"><thead>
        <tr><th>시각</th><th>소스</th><th>PII 유형</th><th>고위험</th><th>외부성</th><th>모델</th><th>체크섬</th><th>사용자</th><th>부서</th><th>지문</th></tr>
      </thead><tbody id="logbody"></tbody></table></div>
    `;
    mcontent.innerHTML = head;
    const body = document.getElementById('logbody');
    currentRows.slice(0,200).forEach(l=>{
      const t = l.time.toISOString().replace('T',' ').slice(0,16);
      const chk = l.checksum_pass===null?'-':(l.checksum_pass?'PASS':'FAIL');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t}</td><td title="${l.source}">${l.source}</td><td>${l.pii_type}</td><td>${l.high?'Y':'N'}</td><td>${l.dest==='external'?'EXT':'INT'}</td><td>${l.model}</td><td>${chk}</td><td>${l.user}</td><td>${l.dept}</td><td class="mono">${l.fingerprint}</td>`;
      body.appendChild(tr);
    });
  }

  function filterAndRender(baseRows){
    const q = search.value.trim().toLowerCase();
    const pf = piifilter.value;
    let rows = baseRows;
    if(pf){ rows = rows.filter(l=>l.pii_type===pf); }
    if(q){
      rows = rows.filter(l=> (l.source+l.user+l.dept+l.pii_type+l.model).toLowerCase().includes(q) );
    }
    renderLogs(rows);
  }
  search.addEventListener('input', ()=>filterAndRender(currentRows));
  piifilter.addEventListener('change', ()=>filterAndRender(currentRows));

  // draw bar charts with drilldown
  barChart(byHourCanvas, byHourVals, hourLabels, (idx)=>{
    const logsHour = win.filter(l=>l.time.getHours()===idx);
    openModal(`시간대 상세 — ${String(idx).padStart(2,'0')}시`, logsHour);
  });
  barChart(byWeekCanvas, byWeekVals, weekLabels, (idx)=>{
    const logsWeek = win.filter(l=> ((l.time.getDay()+6)%7)===idx );
    openModal(`요일 상세 — ${weekLabels[idx]}`, logsWeek);
  });

  // ---------- Panel click handlers ----------
  document.querySelectorAll('.panel[data-detail]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const key = el.getAttribute('data-detail');
      if(key==='total'){ openModal('총 탐지 수 — 상세 로그', last7); }
      else if(key==='highrisk'){ openModal('고위험 PII — 상세 로그', last7.filter(l=>l.high)); }
      else if(key==='valid'){ openModal('검증 통과율 — 상세 로그(검증대상만)', last7.filter(l=>l.checksum_pass!==null)); }
      else if(key==='trend'){ openModal('시간 추이 — 최근 30일 로그', win); }
      else if(key==='topsources'){ openModal('Top N 소스 — 관련 로그', win.filter(l=> topSources.some(t=>t.k===l.source))); }
      else if(key==='contrib'){ openModal('부서/사용자 — 관련 로그', win.filter(l=> topEntities.some(t=>t.k===l.dept || t.k===l.user))); }
      else if(key==='models'){ openModal('모델 비교 — 전체 로그', win); }
    });
  });

  // Tables
  function topBy(key, n=5, filter=()=>true){
    const map = new Map();
    win.filter(filter).forEach(l=>{const k=l[key]; map.set(k,(map.get(k)||0)+1)});
    return Array.from(map.entries()).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v).slice(0,n);
  }
  const topSources = topBy('source', 5);
  const tb = document.querySelector('#topSources tbody');
  topSources.forEach(r=>{
    const hr = Math.round(100 * win.filter(l=>l.source===r.k && l.high).length / Math.max(1, win.filter(l=>l.source===r.k).length));
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.k}</td><td>${r.v.toLocaleString('ko-KR')}</td><td>${hr}%</td>`;
    tb.appendChild(tr);
  });
  function topByAny(){
    const res=[];
    const deptsArr=['Sales','R&D','Support','Ops','HR'];
    deptsArr.forEach(d=>res.push({k:d,v:win.filter(l=>l.dept===d).length}));
    ['u-10232','u-9981','u-7731','u-5520','u-3302'].forEach(u=>res.push({k:u,v:win.filter(l=>l.user===u).length}));
    return res.sort((a,b)=>b.v-a.v).slice(0,5);
  }
  const topEntities = topByAny();
  const cb = document.querySelector('#contrib tbody');
  topEntities.forEach(r=>{
    const isDept = ['Sales','R&D','Support','Ops','HR'].includes(r.k);
    const hr = Math.round(100 * win.filter(l=>(isDept?l.dept===r.k:l.user===r.k)).filter(l=>l.high).length / Math.max(1, win.filter(l=>(isDept?l.dept===r.k:l.user===r.k)).length));
    const name = isDept ? `부서 · ${r.k}` : `사용자 · ${r.k}`;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td>${r.v.toLocaleString('ko-KR')}</td><td>${hr}%</td>`;
    tr.dataset.key = r.k;
    cb.appendChild(tr);
  });

  // Tables drilldown
  document.getElementById('topSources').addEventListener('click', (e)=>{
    const tr = e.target.closest('tr'); if(!tr || tr.rowIndex===0) return;
    const src = tr.children[0].textContent;
    openModal(`소스 상세 — ${src}`, win.filter(l=>l.source===src));
  });
  document.getElementById('contrib').addEventListener('click', (e)=>{
    const tr = e.target.closest('tr'); if(!tr || tr.rowIndex===0) return;
    const key = tr.dataset.key || tr.children[0].textContent.split(' · ').pop();
    openModal(`대상 상세 — ${key}`, win.filter(l=>l.dept===key || l.user===key));
  });

  // CSV download of current view
  const downloadBtn2 = document.getElementById('download');
  function rowsToCSV(rows){
    const header = ['time','source','pii_type','high','dest','model','checksum_pass','user','dept','fingerprint'];
    const lines = [header.join(',')];
    rows.forEach(l=>{
      const vals = [
        l.time.toISOString(),
        `"${l.source.replace(/"/g,'""')}"`,
        l.pii_type,
        l.high?'Y':'N',
        l.dest,
        l.model,
        l.checksum_pass===null?'':(l.checksum_pass?'PASS':'FAIL'),
        l.user,
        l.dept,
        l.fingerprint
      ];
      lines.push(vals.join(','));
    });
    return lines.join('\n');
  }
  downloadBtn2.addEventListener('click', ()=>{
    const csv = rowsToCSV(currentRows);
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'pii_logs_mock.csv'; a.click();
    URL.revokeObjectURL(url);
  });
});
</script>
</body>
</html>
