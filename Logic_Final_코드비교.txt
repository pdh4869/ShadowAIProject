================================================================================
Logic_Final.py ì½”ë“œ ë¹„êµ (ë³€ê²½ ì „ vs ë³€ê²½ í›„)
================================================================================

ğŸ“… ì‘ì„±ì¼: 2024ë…„
ğŸ“ ëª©ì : ì‹¤ì œ ì½”ë“œ ë ˆë²¨ì—ì„œ ë³€ê²½ ì „í›„ ë¹„êµ

================================================================================
1. ì „í™”ë²ˆí˜¸ íƒì§€ - detect_by_regex() í•¨ìˆ˜
================================================================================

[ë³€ê²½ ì „ - ì œê³µëœ ì½”ë“œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def detect_by_regex(Text: str) -> list:
    normalized_text = re.sub(r'[\s\-]', '', Text)
    detected = []
    for label, pattern in COMPILED_PATTERNS.items():
        for match in pattern.finditer(Text):
            item = {"type": label, "value": match.group(), "span": match.span()}
            if label == "card":
                item["status"] = "valid" if validate_luhn(item["value"]) else "invalid (Luhn)"
            if label == "ssn":
                item["status"] = "valid" if validate_ssn(item["value"]) else "invalid (SSN)"
            detected.append(item)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ë³€ê²½ í›„ - í˜„ì¬ ë²„ì „]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def detect_by_regex(Text: str) -> list:
    normalized_text = re.sub(r'[\s\-]', '', Text)
    detected = []
    seen_values = set()  # ì¤‘ë³µ ë°©ì§€
    for label, pattern in COMPILED_PATTERNS.items():
        for match in pattern.finditer(Text):
            # ì „í™”ë²ˆí˜¸ ê²€ì¦
            if label == "phone":
                start, end = match.span()
                matched_text = match.group()
                phone_digits = re.sub(r'\D', '', matched_text)
                
                # ì „í™”ë²ˆí˜¸ ê¸¸ì´ ê²€ì¦ (9~11ìë¦¬)
                if len(phone_digits) < 9 or len(phone_digits) > 11:
                    continue
                
                # ìœ íš¨í•œ ì „í™”ë²ˆí˜¸ í˜•ì‹ì¸ì§€ ë¨¼ì € ê²€ì¦
                valid_prefixes = ['010', '02', '031', '032', '033', '041', '042', '043', '044', 
                                  '051', '052', '053', '054', '055', '061', '062', '063', '064', '070']
                if not any(phone_digits.startswith(prefix) for prefix in valid_prefixes):
                    continue
                
                # ì•ë’¤ ì¢ì€ ì»¨í…ìŠ¤íŠ¸ í™•ì¸
                context_start = max(0, start - 10)
                context_end = min(len(Text), end + 10)
                context = Text[context_start:context_end]
                
                # ë‚ ì§œ íŒ¨í„´ì´ ë°”ë¡œ ì¸ì ‘í•´ ìˆìœ¼ë©´ ì œì™¸
                if re.search(r'(19|20)\d{2}[ë…„ì›”ì¼\-/\.]', context):
                    continue
                
                # ì•ë’¤ì— ì˜ë¬¸ìê°€ ë¶™ì–´ìˆìœ¼ë©´ ì œì™¸
                if (start > 0 and Text[start-1].isalpha()) or (end < len(Text) and Text[end].isalpha()):
                    continue
                
                # ì—°ì†ëœ ìˆ«ì ì²´í¬
                if len(phone_digits) > 1:
                    is_sequential = all(int(phone_digits[i]) == (int(phone_digits[i-1]) + 1) % 10 for i in range(1, len(phone_digits)))
                    if is_sequential:
                        continue
            
            # ìƒë…„ì›”ì¼ ê²€ì¦: í‚¤ì›Œë“œ ê¸°ë°˜ í•„í„°ë§
            if label == "birth":
                start, end = match.span()
                # ì•ë’¤ 50ê¸€ì ë²”ìœ„ì—ì„œ í‚¤ì›Œë“œ ì°¾ê¸°
                context_start = max(0, start - 50)
                context_end = min(len(Text), end + 50)
                context = Text[context_start:context_end].lower()
                
                # ìƒë…„ì›”ì¼ ê´€ë ¨ í‚¤ì›Œë“œ
                birth_keywords = ['ìƒë…„ì›”ì¼', 'ìƒì¼', 'ì¶œìƒ', 'ìƒë…„', 'birth', 'dob', 'date of birth']
                # ì œì™¸ í‚¤ì›Œë“œ (ì…ì‚¬ì¼ ë“±)
                exclude_keywords = ['ì…ì‚¬', 'í‡´ì‚¬', 'ê³„ì•½', 'ì‹ ê³ ', 'ë“±ë¡', 'ìˆ˜ì •', 'ë°œê¸‰', 'ìŠ¹ì¸', 'ìŠ¹ì¸ì¼', 'ê°€ì…', 'ì‹ ì²­', 'join', 'hire', 'contract', 'register']
                
                has_birth_keyword = any(kw in context for kw in birth_keywords)
                has_exclude_keyword = any(kw in context for kw in exclude_keywords)
                
                # ìƒë…„ì›”ì¼ í‚¤ì›Œë“œê°€ ìˆê³  ì œì™¸ í‚¤ì›Œë“œê°€ ì—†ì„ ë•Œë§Œ íƒì§€
                if not has_birth_keyword or has_exclude_keyword:
                    continue
            
            matched_value = match.group()
            # ì¤‘ë³µ ì²´í¬
            value_key = f"{label}:{matched_value}"
            if value_key in seen_values:
                continue
            seen_values.add(value_key)
            
            item = {"type": label, "value": matched_value, "span": match.span()}
            if label == "card":
                item["status"] = "valid" if validate_luhn(item["value"]) else "invalid (Luhn)"
            if label == "ssn":
                item["status"] = "valid" if validate_ssn(item["value"]) else "invalid (SSN)"
            detected.append(item)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

================================================================================
2. ì´ë¦„ íƒì§€ - detect_by_ner() í•¨ìˆ˜ (PS/PER ë¸”ë¡)
================================================================================

[ë³€ê²½ ì „ - ì œê³µëœ ì½”ë“œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if Label in ['PS', 'PER']:
    clean_word = Word.replace(" ", "").strip()
    
    if clean_word in NAME_BLACKLIST:
        continue
    
    if len(clean_word) <= 1 or clean_word.isdigit() or not any('\uac00' <= c <= '\ud7a3' for c in clean_word):
        continue
    
    org_keywords = ['íšŒì‚¬', 'ì „ì', 'ê·¸ë£¹', 'ì€í–‰', 'ë³‘ì›', 'í•™êµ', 'íŒ€', 'ë¶€']
    if any(kw in clean_word for kw in org_keywords):
        continue

    if len(clean_word) == 2 and score < 0.90:
        continue
    if len(clean_word) >= 4 and score < 0.80:
        continue
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ë³€ê²½ í›„ - í˜„ì¬ ë²„ì „]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if Label in ['PS', 'PER']:
    clean_word = Word.replace(" ", "").strip()
    if len(clean_word) <= 1 or clean_word.isdigit() or not any('\uac00' <= c <= '\ud7a3' for c in clean_word):
        continue
    
    # ìˆ«ì í¬í•¨ ì œì™¸
    if any(c.isdigit() for c in clean_word):
        continue
    
    # ì œì™¸ ë‹¨ì–´ í•„í„° (ì •ê·œì‹ê³¼ ë™ì¼)
    if clean_word in exclude_words:
        continue
    
    # ì§ìœ„ í‚¤ì›Œë“œ ì œì™¸
    position_keywords = ['ì‚¬ì›', 'ëŒ€ë¦¬', 'ê³¼ì¥', 'ì°¨ì¥', 'ë¶€ì¥', 'ì´ì‚¬', 'ìƒë¬´', 'ì „ë¬´', 'ë¶€ì‚¬ì¥', 'ì‚¬ì¥', 'ì£¼ì„', 'ì„ ì„', 'ì±…ì„', 'ìˆ˜ì„', 'ë¶€ìˆ˜ì„', 'ì›ì¥', 'ë¶€ì›ì¥', 'êµ­ì¥', 'ë¶€êµ­ì¥', 'ì‹¤ì¥', 'íŒ€ì¥']
    if clean_word in position_keywords:
        continue
    
    org_keywords = ['íšŒì‚¬', 'ì „ì', 'ê·¸ë£¹', 'ê¸°ì—…', 'ì£¼ì‹íšŒì‚¬', '(ì£¼)', 'ã‰¼', 'í•™êµ', 'ëŒ€í•™êµ', 'ëŒ€í•™', 'ê³ ë“±í•™êµ', 'ì¤‘í•™êµ', 'ì´ˆë“±í•™êµ', 'ë³‘ì›', 'ì˜ì›', 'ì„¼í„°', 'ì—°êµ¬ì†Œ', 'ì¬ë‹¨', 'í˜‘íšŒ', 'ì€í–‰', 'ë¶€ì„œ', 'íŒ€', 'ë³¸ë¶€', 'ì§€ì ', 'ì˜ì—…ì†Œ', 'ì¶•ì‚°', 'ë†ì¥', 'ëª©ì¥', 'ë§ˆíŠ¸', 'í”ŒëŸ¬ìŠ¤', 'ì í¬', 'ìƒíšŒ']
    if any(kw in clean_word for kw in org_keywords):
        if clean_word not in detected_orgs:
            Detected.append({"type": "ORG", "value": Word, "span": (Start, End)})
            detected_orgs.add(clean_word)
        continue
    
    # 3ê¸€ì í•œê¸€ ì´ë¦„ë§Œ í—ˆìš©
    if len(clean_word) != 3:
        continue
    
    # ì„±ì”¨ë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©´ ì œì™¸
    if clean_word[0] not in KOREAN_SURNAMES:
        continue
    
    # ì¼ë°˜ ëª…ì‚¬ íŒ¨í„´ ì œì™¸ (ì¡°ì‚¬ í¬í•¨)
    if clean_word.endswith(('ì„', 'ë¥¼', 'ì´', 'ê°€', 'ì€', 'ëŠ”', 'ì—', 'ì˜', 'ë¡œ', 'ì™€', 'ê³¼')):
        continue
    
    # ì¤‘ë³µ ë°©ì§€
    if clean_word in detected_names:
        continue
    
    # í•„í„° í†µê³¼í•œ ì´ë¦„ë§Œ ì¶”ê°€
    Detected.append({"type": Label, "value": Word, "span": (Start, End)})
    detected_names.add(clean_word)
    continue
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

================================================================================
3. NER 512 í† í° ì œí•œ í•´ê²° - detect_by_ner() í•¨ìˆ˜
================================================================================

[ë³€ê²½ ì „ - ì œê³µëœ ì½”ë“œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    ner_results = ner_pipeline(Text)
    
    for entity in ner_results:
        Label = entity['entity_group'].upper()
        Word = entity['word'].replace('##', '')
        # ... ì²˜ë¦¬ ë¡œì§
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ë³€ê²½ í›„ - í˜„ì¬ ë²„ì „]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    # NER ëª¨ë¸ 512 í† í° ì œí•œ í•´ê²°: ë¶„í•  ì²˜ë¦¬
    ner_results = []
    max_length = 500  # ì•ˆì „ ë§ˆì§„
    if len(Text) > max_length:
        chunks = [Text[i:i+max_length] for i in range(0, len(Text), max_length)]
        for chunk in chunks:
            ner_results.extend(ner_pipeline(chunk))
    else:
        ner_results = ner_pipeline(Text)
    
    for entity in ner_results:
        Label = entity['entity_group'].upper()
        Word = entity['word'].replace('##', '')
        # ... ì²˜ë¦¬ ë¡œì§
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

================================================================================
4. HWP íŒŒì¼ ì²˜ë¦¬ - parse_file() í•¨ìˆ˜
================================================================================

[ë³€ê²½ ì „ - ì œê³µëœ ì½”ë“œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
elif File_Ext == "hwp":
    # ... olefile ì²˜ë¦¬ ...
    
    # [FIX 2] í…ìŠ¤íŠ¸ ì¡´ì¬ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ í•­ìƒ ì´ë¯¸ì§€ OCRì„ ì‹¤í–‰
    try:
        ocr_text = run_ocr_on_hwp_images(File_Bytes)
        if ocr_text.strip():
            logging.info(f"[INFO] âœ“ HWP(ole) ì´ë¯¸ì§€ OCR ì‹¤í–‰: {len(ocr_text)}ì ê°ì§€")
    except Exception as e:
        logging.warn(f"[WARN] HWP(ole) ì´ë¯¸ì§€ OCR ì‹¤í–‰ ì‹¤íŒ¨: {e}")

    ole.close()

    # ë³¸ë¬¸ í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ OCR í…ìŠ¤íŠ¸ë¥¼ ê²°í•©
    text = (text.strip() + "\n" + ocr_text.strip()).strip()

    # --- [ì¶”ê°€ëœ ê¸°ëŠ¥] Logic (1).pyì˜ HWP í•œê¸€ ë„ì–´ì“°ê¸° ì •ê·œí™” ---
    original_text = text
    while True:
        prev = text
        text = re.sub(r'([ê°€-í£])\s+([ê°€-í£])(?=\s|[ê°€-í£]|$)', r'\1\2', text)
        if prev == text:
            break
    
    if text != original_text:
        logging.info(f"[INFO] âš  HWP í•œê¸€ ë„ì–´ì“°ê¸° ì •ê·œí™” ì ìš©")
    # --- [ì¶”ê°€ ì™„ë£Œ] ---
    
    return re.sub(r'\s+', ' ', text.strip()), False
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ë³€ê²½ í›„ - í˜„ì¬ ë²„ì „]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
elif File_Ext == "hwp":
    # ... olefile ì²˜ë¦¬ ...
    
    # í…ìŠ¤íŠ¸ ìœ ë¬´ì™€ ê´€ê³„ì—†ì´ í•­ìƒ OCR ì‹¤í–‰ (ì´ë¯¸ì§€ ë‚´ í…ìŠ¤íŠ¸ íƒì§€)
    ocr_text = run_ocr_on_hwp_images(File_Bytes)
    if ocr_text:
        print(f"[INFO] HWP ì´ë¯¸ì§€ OCR ì¶”ì¶œ: {len(ocr_text)}ê¸€ì")
        text = (text + "\n" + ocr_text).strip()
    ole.close()
    text = re.sub(r'\s+', ' ', text).strip()
    return text, False
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ì°¨ì´ì : ì œê³µëœ ì½”ë“œì— HWP ë„ì–´ì“°ê¸° ì •ê·œí™” ê¸°ëŠ¥ ì¶”ê°€ë¨

================================================================================
5. win32com ì ˆëŒ€ ê²½ë¡œ ì²˜ë¦¬ - parse_file() í•¨ìˆ˜
================================================================================

[ë³€ê²½ ì „ - í˜„ì¬ ë²„ì „]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# HWP ë³€í™˜
hwp = win32com.client.Dispatch("HWPFrame.HwpObject")
hwp.RegisterModule("FilePathCheckDLL", "FilePathCheckerModule")
hwp.Open(tmp_path)
hwp.SaveAs(hwpx_path, "HWPX")
hwp.Quit()

# XLS ë³€í™˜
excel = win32com.client.Dispatch("Excel.Application")
wb = excel.Workbooks.Open(tmp_path)
wb.SaveAs(xlsx_path, FileFormat=51)

# PPT ë³€í™˜
pp = win32com.client.Dispatch("PowerPoint.Application")
pres = pp.Presentations.Open(tmp_path, WithWindow=False)
pres.SaveAs(pptx_path, FileFormat=24)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ë³€ê²½ í›„ - ì œê³µëœ ì½”ë“œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# HWP ë³€í™˜
hwp = win32com.client.Dispatch("HWPFrame.HwpObject")
hwp.RegisterModule("FilePathCheckDLL", "FilePathCheckerModule")
# [FIX 1] COM ê°ì²´ëŠ” ì ˆëŒ€ ê²½ë¡œë¥¼ ì‚¬ìš©í•´ì•¼ HWP ë³€í™˜ ì˜¤ë¥˜(-2147352562)ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
hwp.Open(os.path.abspath(tmp_path))
hwp.SaveAs(os.path.abspath(hwpx_path), "HWPX")
hwp.Quit()

# XLS ë³€í™˜
excel = win32com.client.Dispatch("Excel.Application")
wb = excel.Workbooks.Open(os.path.abspath(tmp_path))  # [FIX 1] ì ˆëŒ€ê²½ë¡œ
wb.SaveAs(os.path.abspath(xlsx_path), FileFormat=51)  # [FIX 1] ì ˆëŒ€ê²½ë¡œ

# PPT ë³€í™˜
pp = win32com.client.Dispatch("PowerPoint.Application")
pres = pp.Presentations.Open(os.path.abspath(tmp_path), WithWindow=False)  # [FIX 1] ì ˆëŒ€ê²½ë¡œ
pres.SaveAs(os.path.abspath(pptx_path), FileFormat=24)  # [FIX 1] ì ˆëŒ€ê²½ë¡œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ì°¨ì´ì : ì œê³µëœ ì½”ë“œì— os.path.abspath() ì¶”ê°€ë¡œ COM ì˜¤ë¥˜ ë°©ì§€

================================================================================
6. ì¡°í•© ìœ„í—˜ë„ ë¶„ì„ - analyze_combination_risk() í•¨ìˆ˜
================================================================================

[ë³€ê²½ ì „ - ì œê³µëœ ì½”ë“œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def analyze_combination_risk(detected_items, text):
    if len(detected_items) < 2:
        return None

    categorized = {}
    for it in detected_items:
        cat = categorize_detection(it.get('type',''))
        categorized.setdefault(cat, []).append(it)

    identifiers = categorized.get('identifier', [])
    quasis = categorized.get('quasi', [])
    sensitives = categorized.get('sensitive', [])
    id_cnt = len(identifiers)
    q_cnt = len(quasis)
    sen_cnt = len(sensitives)

    # ë°”ë¡œ ìœ„í—˜ë„ ê³„ì‚°ìœ¼ë¡œ ì§„í–‰
    if sen_cnt > 0 and id_cnt > 0:
        risk_level = 'critical'
        # ...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ë³€ê²½ í›„ - í˜„ì¬ ë²„ì „]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def analyze_combination_risk(detected_items, text):
    if len(detected_items) < 2:
        return None

    categorized = {}
    for it in detected_items:
        cat = categorize_detection(it.get('type',''))
        categorized.setdefault(cat, []).append(it)

    identifiers = categorized.get('identifier', [])
    quasis = categorized.get('quasi', [])
    sensitives = categorized.get('sensitive', [])
    id_cnt = len(identifiers)
    q_cnt = len(quasis)
    sen_cnt = len(sensitives)

    # ì¤€ì‹ë³„ì í•„í„°ë§: ì¡°ì§ëª…/ì£¼ì†Œ/ì§ì±…ë§Œ ìˆëŠ” ê²½ìš° ì œì™¸
    quasi_types = [q.get('type') for q in quasis]
    
    # ì¡°ì§ëª…ë§Œ 2ê°œ ì´ìƒì¸ ê²½ìš° ì œì™¸
    org_only = all(t in ['ORG', 'OG'] for t in quasi_types)
    if org_only and q_cnt >= 2 and id_cnt == 0:
        return None
    
    # ì¡°ì§ëª…+ì£¼ì†Œë§Œ ìˆëŠ” ê²½ìš° ì œì™¸
    org_lc_only = all(t in ['ORG', 'OG', 'LC', 'LOC'] for t in quasi_types)
    if org_lc_only and q_cnt >= 2 and id_cnt == 0:
        return None
    
    # ì¡°ì§ëª…+ì§ì±…, ì£¼ì†Œ+ì§ì±…, ì¡°ì§+ì£¼ì†Œ+ì§ì±… ì¡°í•© ì œì™¸
    org_pos_lc_only = all(t in ['ORG', 'OG', 'LC', 'LOC', 'position'] for t in quasi_types)
    if org_pos_lc_only and q_cnt >= 2 and id_cnt == 0:
        return None

    # ìœ„í—˜ë„ ê³„ì‚°
    if sen_cnt > 0 and id_cnt > 0:
        risk_level = 'critical'
        # ...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ì°¨ì´ì : í˜„ì¬ ë²„ì „ì— ì¤€ì‹ë³„ì í•„í„°ë§ ë¡œì§ ì¶”ê°€

================================================================================
7. handle_input_raw() í•¨ìˆ˜ - ë³‘ë ¬ ì²˜ë¦¬
================================================================================

[ë³€ê²½ ì „ - ì œê³µëœ ì½”ë“œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def handle_input_raw(Input_Data: bytes, Original_Format: str = None, Original_Filename: str = None):
    if not isinstance(Input_Data, bytes):
        raise ValueError("ì§€ì›í•˜ì§€ ì•ŠëŠ” ì…ë ¥ í˜•ì‹ì…ë‹ˆë‹¤.")
    print(f"\n[INFO] ========== íŒŒì¼ ì²˜ë¦¬ ì‹œì‘ (í™•ì¥ì: {Original_Format}) ==========")

    Parsed_Text, is_image_only = parse_file(Input_Data, Original_Format or "")
    image_detections = scan_file_for_face_images(Input_Data, Original_Format or "")
    
    # ... íƒì§€ ë¡œì§ ...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ë³€ê²½ í›„ - í˜„ì¬ ë²„ì „]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def handle_input_raw(Input_Data: bytes, Original_Format: str = None, Original_Filename: str = None):
    if not isinstance(Input_Data, bytes):
        raise ValueError("ì§€ì›í•˜ì§€ ì•ŠëŠ” ì…ë ¥ í˜•ì‹ì…ë‹ˆë‹¤.")
    print(f"\n[INFO] ========== íŒŒì¼ ì²˜ë¦¬ ì‹œì‘ (í™•ì¥ì: {Original_Format}) ==========")

    # ë³‘ë ¬ ì²˜ë¦¬: í…ìŠ¤íŠ¸ ì¶”ì¶œê³¼ ì–¼êµ´ íƒì§€ë¥¼ ë™ì‹œì— ì‹¤í–‰
    with ThreadPoolExecutor(max_workers=2) as executor:
        text_future = executor.submit(parse_file, Input_Data, Original_Format or "")
        face_future = executor.submit(scan_file_for_face_images, Input_Data, Original_Format or "")
        
        Parsed_Text, is_image_only = text_future.result()
        image_detections = face_future.result()
    
    # ... íƒì§€ ë¡œì§ ...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ì°¨ì´ì : í˜„ì¬ ë²„ì „ì— ë³‘ë ¬ ì²˜ë¦¬ ì¶”ê°€ë¡œ ì„±ëŠ¥ í–¥ìƒ

================================================================================
8. ì¶”ê°€ íƒì§€ í•¨ìˆ˜ - detect_address()
================================================================================

[í˜„ì¬ ë²„ì „]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í•¨ìˆ˜ ì—†ìŒ - NER ë‚´ë¶€ì—ì„œ ì •ê·œì‹ìœ¼ë¡œ ì²˜ë¦¬
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ì œê³µëœ ì½”ë“œ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def detect_address(text: str) -> list:
    """ê°„ë‹¨ ë³´ì¡° ì£¼ì†Œ íƒì§€: ì‹œ/ë„ ê¸°ë°˜, ìš°í¸ë²ˆí˜¸, ë„ë¡œëª…, ì§€ë²ˆ, ì˜ë¬¸ ì£¼ì†Œë¥¼ í¬í•¨í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤."""
    out = []
    try:
        # ADDR_PATTERN(ì‹œ/ë„+êµ¬/ë™)ìœ¼ë¡œ ì£¼ì†Œ íƒì§€
        for m in ADDR_PATTERN.finditer(text):
            addr = m.group().strip()
            out.append({"type": "LC", "value": addr, "span": m.span()})

        # ìš°í¸ë²ˆí˜¸ íƒì§€
        for m in ZIP_PATTERN.finditer(text):
            out.append({"type": "zipcode", "value": m.group().strip(), "span": m.span()})

        # ë„ë¡œëª…/ì§€ë²ˆ íƒì§€
        for m in STREET_PATTERN.finditer(text):
            out.append({"type": "LC", "value": m.group().strip(), "span": m.span()})

        # ì˜ë¬¸ ì£¼ì†Œ íƒì§€
        for m in EN_ADDR_PATTERN.finditer(text):
            out.append({"type": "LC", "value": m.group().strip(), "span": m.span()})

    except Exception as e:
        logging.error(f"[ERROR] ì£¼ì†Œ íƒì§€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

    return out
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ì°¨ì´ì : ì œê³µëœ ì½”ë“œì— ë³„ë„ ì£¼ì†Œ íƒì§€ í•¨ìˆ˜ ì¡´ì¬ (ë” ë‹¤ì–‘í•œ íŒ¨í„´ ì§€ì›)

================================================================================
ìš”ì•½
================================================================================

í˜„ì¬ ë²„ì „ì˜ ì£¼ìš” ê°œì„  ì‚¬í•­:
1. âœ… ì „í™”ë²ˆí˜¸/ìƒë…„ì›”ì¼ ì˜¤íƒì§€ í•„í„°ë§ (70ì¤„ ì¶”ê°€)
2. âœ… ì´ë¦„ íƒì§€ ë‹¤ì¸µ í•„í„°ë§ (40ì¤„ ì¶”ê°€)
3. âœ… NER 512 í† í° ì œí•œ í•´ê²° (10ì¤„ ì¶”ê°€)
4. âœ… ì¡°í•© ìœ„í—˜ë„ ì¤€ì‹ë³„ì í•„í„°ë§ (15ì¤„ ì¶”ê°€)
5. âœ… ë³‘ë ¬ ì²˜ë¦¬ (5ì¤„ ì¶”ê°€)

ì œê³µëœ ì½”ë“œì˜ ì¶”ê°€ ê¸°ëŠ¥:
1. âœ… HWP ë„ì–´ì“°ê¸° ì •ê·œí™” (10ì¤„)
2. âœ… win32com ì ˆëŒ€ ê²½ë¡œ ì²˜ë¦¬ (os.path.abspath ì¶”ê°€)
3. âœ… detect_address() í•¨ìˆ˜ (30ì¤„)
4. âœ… ìš°í¸ë²ˆí˜¸ íƒì§€ ì§€ì›

ê¶Œì¥: í˜„ì¬ ë²„ì „ + ì œê³µëœ ì½”ë“œì˜ HWP ì •ê·œí™” + win32com ì ˆëŒ€ê²½ë¡œ = ìµœì  ë²„ì „

================================================================================
